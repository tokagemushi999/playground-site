<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Analyzer Pro</title>
    <!--
    Agency Analyzer Pro - Frontend (v3.0)
    
    新機能:
    - 2段階検索（クイック → 詳細）
    - 中断ボタン改善
    - 履歴削除機能
    
    クイック: 2検索/タレント（プロフィール+SNS）
    詳細: 8検索/タレント（全項目）
    -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f8fafc; }
        .spinner { animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;
        
        // APIエンドポイント（分割版用）
        const PROXY_URL = window.location.href.replace(/[^\/]+$/, '') + 'agency_analyzer_api.php';
        
        // 現在日時を取得
        const NOW = new Date();
        const CURRENT_YEAR = NOW.getFullYear();
        const CURRENT_MONTH = NOW.getMonth() + 1;
        const CURRENT_DATE = `${CURRENT_YEAR}年${CURRENT_MONTH}月`;
        const YEAR_RANGE = `${CURRENT_YEAR - 2}年〜${CURRENT_YEAR}年`;
        const YEAR_RANGE_SHORT = `${CURRENT_YEAR - 2}-${CURRENT_YEAR}`;

        // ====== 検索プロンプト（8分割） ======
        
        const PROMPT_ROSTER = `
指定された芸能事務所の所属タレント一覧を調査してください。
事務所名: {agency_name}
公式サイトやWikipediaから所属タレント・アーティストをリストアップしてください。
出力形式（JSON）:
{ "agency_name": "正式名称", "agency_url": "公式サイトURL", "talents": [{ "id": "T001", "name": "タレント名", "type": "SOLO/GROUP" }] }`;

        const PROMPT_PROFILE = `
「{talent_name}」（{agency_name}所属のタレント/アーティスト）のプロフィール・経歴を詳しく検索してください。

【最重要：同名別人の除外】
検索時に以下を必ず確認してください：
1. "{talent_name} {agency_name}"で検索
2. 検索結果が「{agency_name}」所属であることを確認
3. 所属事務所が異なる同名人物は絶対に含めない

■ 除外すべき情報：
× 同姓同名の一般人
× 別の事務所や別ジャンルの同名人物
× ファンの創作・二次創作情報
× 確認が取れない情報

■ 信頼できるソース：
○ 公式サイト
○ 所属事務所のサイト
○ Wikipedia（出典があるもの）
○ 公式ニュースリリース

調べてほしいこと：
- 正式名称、読み方、活動開始年
- 所属事務所（{agency_name}であることを再確認）
- 所属レコード会社・レーベル

【活動ジャンル ← 最重要：以下の判定基準で正確に分類してください】

■ 判定基準（上から順にチェック、最初に該当したものを採用）：

1. 「アイドル」と公式に名乗っている → アイドル系
   - 女性メンバーのみ → 「女性アイドルグループ」
   - 男性メンバーのみ → 「男性アイドルグループ」
   - ソロ活動 → 「女性ソロアイドル」or「男性ソロアイドル」
   - 例: 乃木坂46、日向坂46、AKB48 → 女性アイドルグループ
   - 例: Snow Man、SixTONES、なにわ男子 → 男性アイドルグループ

2. 自分で楽器を演奏するバンド形態 → バンド系
   - 女性メンバーのみ → 「ガールズバンド」
   - 男性メンバーのみ → 「バンド」or「ロックバンド」
   - 例: SCANDAL、BAND-MAID → ガールズバンド
   - 例: Official髭男dism、King Gnu → バンド

3. 作詞作曲を自分で行う → 「シンガーソングライター」
   - 例: あいみょん、米津玄師、YOASOBI

4. 声優業がメイン → 「声優」or「声優アーティスト」
   - 例: 水樹奈々、内田真礼

5. VTuber/バーチャル → 「VTuber」
   - 例: ホロライブ、にじさんじ所属

6. K-POPグループ → 「K-POP」
   - 例: TWICE、BTS、IVE

7. ヒップホップ/ラップがメイン → 「ヒップホップ」
   - 例: Creepy Nuts、変態紳士クラブ

8. 上記に該当しない歌手 → 「アーティスト」

9. 歌わない → 「俳優」「女優」「タレント」「モデル」

■ 注意：
- 「アーティスト」は安易に使わない（アイドルやバンドを見逃さない）
- 複数該当する場合は「主な活動」を優先
- 迷ったら公式サイトの自己紹介文を確認

- 主な出演歴・経歴（TV、ラジオ、映画、舞台、CM等）
- 受賞歴

【グループの場合は必ず以下も調べてください】
- グループの性別構成（女性グループ / 男性グループ / 混合）
- メンバー人数
- 各メンバーの情報：
  * メンバー名（本名またはニックネーム）
  * 生年月日（誕生日）
  * 担当・ポジション（ボーカル、ダンス、リーダー等）
  * 加入年（わかる場合）

できるだけ詳しく教えてください。`;

        // SNS検索プロンプト（シンプル版）
        const PROMPT_SNS = `
「{talent_name}」（{agency_name}所属）の公式SNSアカウントを検索してください。

【絶対厳守：同名別人の除外】
以下のチェックをすべて行い、合格したアカウントのみ報告してください：

■ 確認必須チェックリスト：
□ プロフィールに「{agency_name}」または所属事務所の記載があるか
□ プロフィールに「{talent_name}」本人であることを示す記載があるか
□ 公式サイトからリンクされているか
□ 認証バッジ（青いチェックマーク）があるか
□ 他の公式SNSと相互フォロー/リンクがあるか

■ 除外すべきアカウント：
× ファンアカウント（「ファン」「推し」「応援」等を含む）
× 同姓同名の別人（別の事務所、別ジャンル、一般人）
× 非公式まとめアカウント
× 更新が長期間停止しているアカウント
× プロフィールに所属事務所の記載がないアカウント

【検索対象と確認方法】
1. Twitter/X
   - 検索: "{talent_name} {agency_name} twitter 公式"
   - 公式サイトのSNSリンクから確認
   - @ユーザー名とフォロワー数を報告

2. YouTube
   - 検索: "{talent_name} {agency_name} youtube 公式チャンネル"
   - チャンネル名に本人名または公式表記があるか確認
   - 動画内容が本人の活動と一致するか確認
   - チャンネルURLと登録者数を報告

3. Instagram
   - 検索: "{talent_name} {agency_name} instagram 公式"
   - プロフィールに所属事務所の記載があるか確認
   - @ユーザー名とフォロワー数を報告

4. TikTok
   - 検索: "{talent_name} {agency_name} tiktok 公式"
   - プロフィールに本人確認できる情報があるか確認
   - @ユーザー名とフォロワー数を報告

【報告形式】
確実に本人と確認できたアカウントのみ報告してください。
確認できない場合は「公式アカウント未確認」と記載してください。
絶対に推測でアカウントを報告しないでください。`;

        const PROMPT_LIVE = `
「{talent_name}」（{agency_name}所属のタレント/アーティスト）の${YEAR_RANGE}のライブ・イベント活動を検索してください。

【絶対に守ってください】
- 必ず「{agency_name}」所属の「{talent_name}」のライブ・イベント情報のみを報告
- 同姓同名の別人のイベントは含めない
- 公式発表、ニュース記事、チケットサイト等の信頼できるソースから

【ワンマンライブ・単独公演】
- 開催日、会場名、公演名、キャパシティ

【ツアー】
- ツアー名、開催期間、会場一覧

【フェス・イベント出演】
- イベント名、出演日

【定期公演・レギュラーイベント】

${CURRENT_YEAR - 2}年、${CURRENT_YEAR - 1}年、${CURRENT_YEAR}年それぞれの活動を時系列で教えてください。`;

        const PROMPT_RELEASE = `
「{talent_name}」（{agency_name}所属のタレント/アーティスト）の${YEAR_RANGE}のリリース情報を検索してください。

【絶対に守ってください】
- 必ず「{agency_name}」所属の「{talent_name}」のリリース情報のみを報告
- 同姓同名の別アーティストのリリースは含めない
- 公式サイト、音楽配信サイト、ニュース等の信頼できるソースから

【CD・音楽リリース】
- シングル、アルバムのタイトル、発売日、形態（CD/配信）
- 初回盤、通常盤などの形態

【DVD・Blu-ray・映像作品】
- タイトル、発売日、内容

【リリースイベント（リリイベ）詳細 ← 最重要：徹底的に調べてください】

■ 検索方法（以下すべてを検索してください）：
- "{talent_name} リリースイベント"
- "{talent_name} リリイベ"
- "{talent_name} 握手会"
- "{talent_name} サイン会"
- "{talent_name} チェキ会"
- "{talent_name} 特典会"
- "site:tower.jp {talent_name} イベント"
- "site:hmv.co.jp {talent_name} イベント"
- "{talent_name} {agency_name} イベント"

■ 各イベントごとに以下を【必ず】記載：

1. 開催日時
   - 日付と時間を正確に

2. 会場名と所在地
   - タワーレコード渋谷店、HMV&BOOKS SHIBUYA等
   - 住所または最寄り駅

3. イベント内容
   - 握手会、サイン会、チェキ会、お話し会、ミニライブ等

4. 参加レギュレーション（参加条件）
   - 対象商品：どのCDを購入すればよいか（タイトル名）
   - 購入枚数：1枚から参加可/2枚で1回/複数枚購入で複数回参加可等
   - 参加券の配布方法：先着/抽選/予約優先/整理番号順等
   - 時間制限：1人○秒/○分等
   - 年齢制限：あり/なし

5. 特典内容【重要：必ず調べてください】
   - 購入特典：ブロマイド、生写真、ポストカード、クリアファイル、サイン入り○○等
   - 店舗特典：タワレコ特典、HMV特典等
   - 初回特典、応募抽選特典等
   - 特典の絵柄やバリエーション（A ver.、B ver.等）

6. イベント詳細ページのURL【必須】
   - タワレコ: tower.jp/...
   - HMV: hmv.co.jp/...
   - 公式サイトのイベントページ
   - 情報源のサイト名

【所属レコード会社・レーベル】

${CURRENT_YEAR - 1}年と${CURRENT_YEAR}年のリリイベ情報を特に詳しく教えてください。
特典内容とURLは必ず記載してください。`;

        // リリイベ専用検索プロンプト
        const PROMPT_RELEASE_EVENT = `
「{talent_name}」（{agency_name}所属）のリリースイベント（リリイベ）情報を徹底的に検索してください。

■ 検索ワード（すべて検索してください）：
- "{talent_name} リリースイベント"
- "{talent_name} リリイベ"
- "{talent_name} 握手会"
- "{talent_name} サイン会"  
- "{talent_name} チェキ会"
- "{talent_name} 特典会"
- "site:tower.jp {talent_name} イベント"
- "site:hmv.co.jp {talent_name} イベント"
- "{talent_name} 購入特典"
- "{talent_name} 店舗特典"

【${YEAR_RANGE}のリリースイベント一覧】
各イベントについて以下を【すべて】報告：

1. 日時：○年○月○日（曜日）○時〜
2. 会場：店舗名・施設名（住所または最寄り駅）
3. 内容：握手会/サイン会/チェキ会/お話し会/ミニライブ等
4. 対象商品：どのCDやDVDの購入が必要か（タイトル名）
5. 参加条件（レギュレーション）：
   - 購入枚数（1枚から/2枚で1回等）
   - 参加券配布方法（先着/抽選/整理番号）
   - 制限時間（○秒/○分）
   - 年齢制限

6. 特典内容を詳しく：
   - 購入特典：ブロマイド、生写真、ポストカード、クリアファイル、ステッカー等
   - 店舗別特典：タワレコ特典、HMV特典、アニメイト特典等
   - 初回/予約特典
   - 特典の種類数やバリエーション（全○種、ランダム等）

7. 【必須】URL：
   - イベント詳細ページの完全なURL
   - tower.jp/article/... 
   - hmv.co.jp/news/...
   - 公式サイトのイベントページ

8. 情報源：どのサイトで確認したか

過去のイベント実績も含めて、できるだけ多くのイベント情報を報告してください。
特典とURLは必ず記載してください。`;

        const PROMPT_GOODS = `
「{talent_name}」（{agency_name}所属のタレント/アーティスト）のグッズ・物販情報を検索してください。

【絶対に守ってください】
- 必ず「{agency_name}」所属の「{talent_name}」の公式グッズ情報のみを報告
- 非公式グッズ、ファンメイド、同人グッズは含めない
- 同姓同名の別人のグッズは含めない
- 公式ECサイト、公式発表からの情報のみ

【公式ECサイト・オンラインショップ】
- サイトURL
- 運営形態（自社EC、BOOTH、BASE、楽天等）

【${YEAR_RANGE}のグッズラインナップ】
- 販売されているグッズの種類（Tシャツ、タオル、アクキー、ペンライト等）
- 定番商品、限定商品

【グッズの仕入先・製造元】（分かれば）
- OEM先、印刷会社等

【ライブ会場での物販状況】

できるだけ具体的に教えてください。`;

        const PROMPT_FANCLUB = `
「{talent_name}」（{agency_name}所属のタレント/アーティスト）のファンクラブ・ファン層について検索してください。

【絶対に守ってください】
- 必ず「{agency_name}」所属の「{talent_name}」のファンクラブ情報のみを報告
- 非公式ファンコミュニティは含めない
- 同姓同名の別人のファンクラブは含めない

【ファンクラブ】
- 有無、名称
- 公式サイトURL
- 月額/年額料金
- 特典内容
- FC内でのグッズ販売（FC限定EC）の有無

【ファン層の分析 ← 最重要：以下の方法で必ず分析してください】

■ 方法1: 直接検索
以下のキーワードで検索：
- "{talent_name} ファン層"
- "{talent_name} ファン 年齢"
- "{talent_name} 男女比"
- "{talent_name} 客層"
- "{talent_name} ライブ レポ"
- "{talent_name} 現場 感想"

■ 方法2: ライブレポート・イベントレポートから推測
- 「女性ファンが多かった」「男性客中心」などの記述を探す
- 「若い子が多い」「30代くらいの人が多かった」などの記述を探す

■ 方法3: ジャンル・活動形態から推測
以下の一般的な傾向を参考に推測してください：
- 女性アイドルグループ → 男性ファンが多い傾向（7〜9割）
- 男性アイドルグループ → 女性ファンが多い傾向（8〜9割）
- バンド・ロック系 → 男女比が近い傾向
- 女性シンガーソングライター → 女性ファンも多い傾向
- 声優・アニソン系 → 20代後半〜30代が多い傾向
- 地下アイドル → 20代後半〜40代男性が多い傾向

■ 方法4: SNSの傾向から推測
- Instagramが活発 → 女性ファンが多い傾向
- Twitterで熱心な投稿が多い → オタク気質のファンが多い
- TikTokでバズっている → 10代〜20代前半が多い

【回答形式 - 必ずこの形式で回答してください】
■ 性別比: ○○（例：男性8割・女性2割 / ほぼ女性 / 男女半々）
■ 年齢層: ○○（例：20代後半〜30代前半がメイン）
■ 地域: ○○（例：首都圏中心 / 全国的）
■ ファン呼称: ○○
■ 推測根拠: ○○（どの情報から判断したか）

【ファンコミュニティの特徴】
- ファンの雰囲気（熱心、カジュアル等）
- SNSでの活動傾向`;

        // ファン層専用検索プロンプト
        const PROMPT_FANS = `
「{talent_name}」（{agency_name}所属）のファン層・客層について徹底的に調査してください。

【検索ワード - すべて検索してください】
- "{talent_name} ファン層"
- "{talent_name} ファン 年齢"
- "{talent_name} ファン 男女比"
- "{talent_name} ライブ 客層"
- "{talent_name} 現場 レポ"
- "{talent_name} ライブ レポート"
- "{talent_name} イベント 感想"
- "{talent_name} 握手会 レポ"
- "{talent_name} リリイベ レポ"
- "{talent_name} ファン 特徴"
- "{talent_name} オタク"

【調査方法 - 以下の情報源から推測してください】

■ 1. ライブ・イベントレポートから
- ライブレポートやイベントレポートに書かれている客層の描写
- 「女性が多かった」「男性ファンが目立った」「若い子が多い」等の記述
- 会場の雰囲気の描写

■ 2. SNSの分析から
- Twitter/Xでファンのアカウントを見て年齢層や性別を推測
- ファンアートや感想ツイートの傾向
- ハッシュタグの使用状況

■ 3. グッズ・物販の傾向から
- 販売されているグッズの種類（女性向けか男性向けか）
- ペンライトの色、アクスタ、ブロマイド等

■ 4. 公式発表・インタビューから
- アーティスト本人やマネージャーの発言
- 「ファンは〇〇な方が多い」等のコメント

【回答形式】

■ 性別比（必須）
- 具体的に記載：男性○割・女性○割
- または：ほぼ男性 / ほぼ女性 / 男女半々 / やや男性多め / やや女性多め
- 根拠も記載（例：ライブレポートで「女性客が8割」との記述）

■ 年齢層（必須）
- 具体的に記載：○代〜○代が中心
- メイン層とサブ層を分けて（例：20代後半〜30代前半がメイン、10代も一定数）
- 根拠も記載

■ 地域分布
- 首都圏中心 / 関西に強い / 全国的 / 地方にも多い 等

■ ファンの特徴
- ファンの呼称（○○民、○○推し等）
- ファンの雰囲気（熱心、マナーが良い、若い等）
- SNSでの活動傾向

【注意】
- 情報がない場合は「ライブレポート等から推測：○○」のように記載
- 完全に不明な場合は「情報なし」ではなく、類似アーティストとの比較で推測`;

        // ファン層分析用プロンプト（追加検索用）
        const PROMPT_FANS_ANALYSIS = `
「{talent_name}」のファン層を分析してください。

以下の観点から総合的に推測してください：

1. 【音楽ジャンルからの推測】
- {talent_name}の音楽ジャンルやスタイルから、一般的にどのような層がファンになりやすいか

2. 【活動形態からの推測】
- アイドル系なら男性ファンが多い傾向
- バンド系なら男女比が近い傾向
- 女性シンガーソングライターなら女性ファンも多い傾向

3. 【SNSフォロワーの分析】
- InstagramよりTwitterが活発→オタク気質のファンが多い
- TikTokが人気→若年層ファンが多い

4. 【ライブ会場の傾向】
- 渋谷・原宿系の会場→若年層
- Zepp系→幅広い年齢層

回答は以下の形式で：
- 性別比: ○○
- 年齢層: ○○
- 地域: ○○
- 特徴: ○○
- 推測根拠: ○○`;

        // ======= 統合プロンプト（コスト削減用）=======
        
        // PROMPT_ACTIVITY: ライブ + リリース情報を統合
        const PROMPT_ACTIVITY = `
「{talent_name}」の${YEAR_RANGE}の活動情報を検索してください。
※参考: 所属事務所は「{agency_name}」ですが、検索時は「{talent_name}」のみで幅広く検索してください。

━━━━━━━━━━━━━━━━━━
■ ライブ・イベント活動
━━━━━━━━━━━━━━━━━━
検索: "{talent_name} ライブ" "{talent_name} ツアー" "{talent_name} フェス"

【ワンマンライブ・単独公演】開催日、会場名、公演名、キャパシティ
【ツアー】ツアー名、開催期間、会場一覧
【フェス・イベント出演】イベント名、出演日
【定期公演】

━━━━━━━━━━━━━━━━━━
■ リリース情報
━━━━━━━━━━━━━━━━━━
検索: "{talent_name} シングル" "{talent_name} アルバム" "{talent_name} CD"

【CD・音楽】シングル、アルバムのタイトル、発売日、形態
【DVD・Blu-ray】タイトル、発売日
【所属レコード会社・レーベル】

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ 特典会・リリースイベント【最重要：徹底的に調査】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

検索ワード（すべて検索してください）:
- "{talent_name} リリイベ"
- "{talent_name} 握手会"
- "{talent_name} 特典会"
- "{talent_name} サイン会"
- "{talent_name} チェキ会"
- "{talent_name} お話し会"
- "site:tower.jp {talent_name}"
- "site:hmv.co.jp {talent_name}"

【各イベントについて以下を必ず記載】

1. 基本情報
   - 開催日時（○年○月○日 ○時〜）
   - 会場（タワーレコード渋谷店、HMV&BOOKS等）
   - 対象商品（CD/DVDタイトル名）

2. 【特典会の内容 ← 詳細に】
   - 握手会: 個別握手/全員握手/ミニ握手
   - サイン会: サイン入りCD/サイン色紙/サイン入りグッズ
   - チェキ会: ソロチェキ/2ショットチェキ/グループチェキ
   - お話し会: 1対1トーク/グループトーク
   - ミニライブ: 有無、曲数
   - その他: ハイタッチ、お見送り会等

3. 【レギュレーション（参加条件）← 詳細に】
   - 対象商品と枚数: 「○○（CDタイトル）1枚で1回参加」「2枚で1回」等
   - 参加券: 先着配布/抽選/整理番号順/予約特典
   - 時間制限: 1人○秒/○分（握手○秒、トーク○秒等）
   - 年齢制限: あり/なし、何歳以上
   - 撮影: 可/不可、スタッフ撮影のみ等
   - 持ち込み: プレゼント可/不可

4. 【特典内容 ← 詳細に】
   ■ 購入特典（CD購入でもらえるもの）
   - 生写真（サイズ、ランダム/選べる、全○種）
   - ブロマイド（サイズ、種類）
   - ポストカード
   - クリアファイル
   - ステッカー
   - サイン入り○○（抽選/全員）
   
   ■ 店舗別特典
   - タワレコ特典: ○○
   - HMV特典: ○○
   - アニメイト特典: ○○
   - Amazon特典: ○○
   
   ■ 応募特典（シリアル抽選等）
   - 抽選で○名に○○

5. 情報源
   - イベント詳細URL（tower.jp/...、hmv.co.jp/...等）
   - 公式サイトURL

${CURRENT_YEAR - 1}年と${CURRENT_YEAR}年の特典会情報を特に詳しく教えてください。`;

        // PROMPT_FANSERVICE: グッズ + FC + オンラインを統合
        const PROMPT_FANSERVICE = `
「{talent_name}」のファン向けサービス情報を検索してください。
※参考: 所属事務所は「{agency_name}」

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
■ グッズ・物販【最重要：徹底的に調査】
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

検索ワード:
- "{talent_name} グッズ"
- "{talent_name} 公式ショップ"
- "{talent_name} 物販"
- "{talent_name} 生写真"
- "{talent_name} チェキ"
- "{talent_name} ブロマイド"

【公式通販サイト】
- サイト名とURL
- 運営形態: 自社EC / BOOTH / BASE / STORES / 楽天 / その他

【グッズラインナップ ← 詳細に】

■ 写真系グッズ（価格も記載）
- 生写真: サイズ、1枚○円、セット○円、ランダム/選択式、全○種
- ブロマイド: サイズ、価格
- チェキ: ランダムチェキ販売の有無、価格
- ポストカード: 価格、セット内容
- 写真集: タイトル、価格

■ アパレル・身につけるもの
- Tシャツ: 価格帯、デザイン種類
- パーカー/ジャケット
- タオル: マフラータオル、フェイスタオル等
- 法被/はっぴ

■ 応援グッズ
- ペンライト/サイリウム: 公式ペンラの有無、価格、色
- うちわ: 公式うちわの有無
- 推しタオル

■ アクセサリー・小物
- アクリルスタンド（アクスタ）: 価格、ランダム/選択
- アクリルキーホルダー（アクキー）
- 缶バッジ: サイズ、ランダム/選択、全○種
- ラバーバンド
- ストラップ

■ その他
- CD/DVD（通常盤以外の限定盤）
- カレンダー
- クリアファイル
- トレーディングカード

【ランダム商品について】
- ランダム商品の有無
- 全種コンプに必要な金額目安
- 交換文化の有無

【ライブ会場物販】
- 会場限定グッズの有無
- 物販の混雑状況
- 通販での取り扱い

【価格帯の目安】
- 低価格帯（〜1000円）: ○○
- 中価格帯（1000〜3000円）: ○○
- 高価格帯（3000円〜）: ○○

━━━━━━━━━━━━━━━━━━
■ ファンクラブ
━━━━━━━━━━━━━━━━━━
検索: "{talent_name} ファンクラブ" "{talent_name} FC"

- 有無、名称、公式サイトURL
- 料金（月額/年額）
- 入会特典、継続特典
- FC限定グッズ販売の有無
- FC限定イベントの有無

━━━━━━━━━━━━━━━━━━
■ ファン層分析
━━━━━━━━━━━━━━━━━━
検索: "{talent_name} ファン層" "{talent_name} ライブ レポ" "{talent_name} 客層"

- 性別比: 男性○割・女性○割
- 年齢層: ○代が中心
- 地域: 首都圏中心/全国的等
- ファンの呼称や特徴

━━━━━━━━━━━━━━━━━━
■ オンライン特典会
━━━━━━━━━━━━━━━━━━
検索: "{talent_name} オンライン お話し会" "{talent_name} ビデオ通話" "{talent_name} WithLIVE"

- プラットフォーム: WithLIVE / talkport / SHOWROOM / その他
- 料金体系: 1枠○円、○秒○円等
- 開催頻度: 毎週/月○回/不定期
- 参加方法: CD購入/チケット購入/抽選`;

        // PROMPT_NEWS_ALL: ニュース + limista を統合
        const PROMPT_NEWS_ALL = `
「{talent_name}」の最新情報と配信イベント履歴を検索してください。

━━━━━━━━━━━━━━━━━━
■ 最新ニュース・話題
━━━━━━━━━━━━━━━━━━
検索: "{talent_name}" "{talent_name} ニュース"

- 直近のニュース（新曲、ライブ、メディア出演等）
- SNSで話題になっていること
- 今後の予定や発表

━━━━━━━━━━━━━━━━━━
■ limista.com イベント履歴
━━━━━━━━━━━━━━━━━━
検索: "site:limista.com {talent_name}"

limista.comでのオンラインイベント（お話し会、ビデオ通話等）の開催履歴があれば、日時と内容を報告してください。

━━━━━━━━━━━━━━━━━━
■ その他の配信プラットフォーム履歴
━━━━━━━━━━━━━━━━━━
- WithLIVE、talkport、LINE LIVE等での活動履歴`;

        // ======= 特典会・グッズ専用プロンプト（重要情報を深堀り）=======
        
        // PROMPT_TOKUTEN: 特典会・リリイベ専用（詳細版）
        const PROMPT_TOKUTEN = `
「{talent_name}」の特典会・リリースイベント情報を徹底的に検索してください。

【検索ワード - すべて検索】
- "{talent_name} リリイベ"
- "{talent_name} 握手会"
- "{talent_name} 特典会"
- "{talent_name} サイン会"
- "{talent_name} チェキ会"
- "{talent_name} お話し会"
- "{talent_name} ミート&グリート"
- "site:tower.jp {talent_name} イベント"
- "site:hmv.co.jp {talent_name} イベント"
- "site:animate.co.jp {talent_name} イベント"

━━━━━━━━━━━━━━━━━━━━━━━━
【特典会の種類と詳細 ← 重要】
━━━━━━━━━━━━━━━━━━━━━━━━

■ 握手会
- 形式: 個別握手会 / 全員握手会 / ミニ握手会 / グループ握手
- 時間: 1人あたり何秒（例: 10秒、30秒）
- 特徴: 剥がしの有無、会話可能か

■ サイン会
- サイン対象: CD / 色紙 / ポスター / グッズ / 持ち込み可
- 形式: 目の前でサイン / 事前サイン済み
- 追加: 宛名書き可 / 日付入り / メッセージ可

■ チェキ会（撮影会）
- 種類: ソロチェキ / 2ショットチェキ / グループチェキ
- 撮影者: スタッフ撮影 / セルフ撮影可
- ポーズ: 指定可 / お任せ
- 加工: 落書き可 / サイン入り

■ お話し会・トーク会
- 形式: 1対1 / 少人数グループ / 全体
- 時間: 何秒（例: 30秒、1分、2分）
- 内容: フリートーク / テーマあり

■ その他の特典会
- ハイタッチ会
- お見送り会
- ミニライブ（何曲か）
- 囲み撮影会
- プレゼント渡し会

━━━━━━━━━━━━━━━━━━━━━━━━
【レギュレーション（参加条件）← 重要】
━━━━━━━━━━━━━━━━━━━━━━━━

■ 対象商品と必要枚数
- 「○○（CDタイトル）」を○枚購入で1回参加
- 形態指定: 初回盤のみ / 通常盤OK / 全形態対象
- 複数回参加: 可能 / 上限あり（最大○回）

■ 参加券の取得方法
- 先着配布（開店から / イベント当日）
- 抽選（応募方法、当選発表日）
- 整理番号制（番号順に案内）
- 予約特典（事前予約で確定）

■ 時間制限
- 握手: ○秒
- トーク: ○秒
- チェキ: ○秒（撮影+受け取り）

■ 年齢制限
- なし / ○歳以上 / 保護者同伴で可

■ その他ルール
- 撮影: 可 / 不可 / スタッフ撮影のみ
- 録音: 可 / 不可
- プレゼント: 可 / 不可 / 手紙のみ可
- 服装規定: あり / なし

━━━━━━━━━━━━━━━━━━━━━━━━
【購入特典（もらえるもの）← 重要】
━━━━━━━━━━━━━━━━━━━━━━━━

■ 共通特典（どこで買っても）
- 生写真: サイズ、全○種、ランダム/選択
- ブロマイド
- ポストカード
- クリアファイル

■ 店舗別特典
- タワーレコード: ○○（A絵柄）
- HMV: ○○（B絵柄）
- アニメイト: ○○
- Amazon: ○○
- 楽天: ○○
- その他

■ 応募抽選特典
- シリアル応募で抽選○名に○○
- Wチャンス

■ 初回/先着特典
- 初回プレス特典
- 先着購入特典

${CURRENT_YEAR - 1}年〜${CURRENT_YEAR}年の特典会情報を網羅的に報告してください。`;

        // PROMPT_GOODS_DETAIL: グッズ専用（詳細版）
        const PROMPT_GOODS_DETAIL = `
「{talent_name}」の公式グッズ・物販情報を徹底的に検索してください。

【検索ワード - すべて検索】
- "{talent_name} グッズ"
- "{talent_name} 物販"
- "{talent_name} 公式ショップ"
- "{talent_name} 生写真"
- "{talent_name} アクスタ"
- "{talent_name} ペンライト"
- "{talent_name} Tシャツ"

━━━━━━━━━━━━━━━━━━━━━━━━
【公式通販サイト】
━━━━━━━━━━━━━━━━━━━━━━━━
- サイト名:
- URL:
- 運営形態: 自社EC / BOOTH / BASE / STORES / 楽天 / Amazon / その他

━━━━━━━━━━━━━━━━━━━━━━━━
【グッズラインナップ ← 詳細に】
━━━━━━━━━━━━━━━━━━━━━━━━

■ 写真系グッズ【価格必須】
- 生写真
  * サイズ: L判 / 2L判 / その他
  * 価格: 1枚○円、○枚セット○円
  * 販売形式: ランダム / 選べる / コンプセット
  * 種類数: 全○種
  * 更新頻度: 毎月 / ライブごと / 不定期

- ブロマイド
  * サイズ、価格

- ランダムチェキ
  * 価格、全○種

- ポストカード・ポスター
  * サイズ、価格

- 写真集
  * タイトル、価格、ページ数

■ アパレル【価格必須】
- Tシャツ: ○円〜○円、デザイン○種
- パーカー: ○円
- タオル
  * マフラータオル: ○円
  * フェイスタオル: ○円
  * バスタオル: ○円
- 法被/はっぴ: ○円

■ 応援グッズ【価格必須】
- ペンライト
  * 公式ペンラ: あり / なし
  * 価格: ○円
  * カラー: メンバーカラー対応 / 単色
  * 電池式 / 充電式
  
- うちわ
  * 公式うちわ: あり / なし
  * 価格
  
- 推しタオル・推しメンタオル

■ アクリルグッズ【価格必須】
- アクリルスタンド（アクスタ）
  * 価格: ○円
  * 販売形式: ランダム / 選べる
  * 全○種
  
- アクリルキーホルダー（アクキー）
  * 価格、種類数

■ 缶バッジ・ピンズ【価格必須】
- サイズ: ○mm
- 価格: 1個○円
- 販売形式: ランダム / 選べる
- 全○種

■ その他グッズ
- ラバーバンド: ○円
- ストラップ: ○円
- クリアファイル: ○円
- トレーディングカード: 1パック○円、全○種
- カレンダー: ○円
- ぬいぐるみ: ○円

━━━━━━━━━━━━━━━━━━━━━━━━
【ランダム商品について】
━━━━━━━━━━━━━━━━━━━━━━━━
- ランダム商品の有無: あり / なし
- 主なランダム商品: ○○、○○
- 全種コンプに必要な目安金額: 約○円
- 交換・トレード文化: 活発 / あり / ほぼなし

━━━━━━━━━━━━━━━━━━━━━━━━
【ライブ会場物販】
━━━━━━━━━━━━━━━━━━━━━━━━
- 会場限定グッズ: あり / なし
- 事前物販: あり / なし
- 通販での事後販売: あり / なし / 一部あり
- 物販の混雑度: 高い / 普通 / 低い

━━━━━━━━━━━━━━━━━━━━━━━━
【価格帯まとめ】
━━━━━━━━━━━━━━━━━━━━━━━━
- 500円以下: ○○
- 500〜1000円: ○○
- 1000〜2000円: ○○
- 2000〜3000円: ○○
- 3000〜5000円: ○○
- 5000円以上: ○○

できるだけ具体的な商品名と価格を報告してください。`;

        const PROMPT_ONLINE = `
「{talent_name}」（{agency_name}所属のタレント/アーティスト）の${YEAR_RANGE}のオンラインイベントを検索してください。

【絶対に守ってください】
- 必ず「{agency_name}」所属の「{talent_name}」のオンラインイベント情報のみを報告
- 同姓同名の別人のイベントは含めない
- 公式発表、イベントプラットフォームからの情報のみ

【オンライン特典会・お話し会】
- 使用プラットフォーム（リミスタ、WithLIVE、tixplus、SHOWROOM等）
- 開催頻度
- 実施内容（1対1お話し会、サイン会等）

【limista.com（リミスタ）での販売経験】
- "site:limista.com {talent_name}" で検索して、limista.comでイベント販売経験があるか確認
- 経験がある場合は「limista利用経験あり」と明記
- 見つからない場合は「limista利用経験なし」または「不明」

【オンラインライブ・配信ライブ】
- 配信プラットフォーム
- 開催実績

【ファンミーティング（オンライン）】

【その他のオンラインイベント】
- 生配信、YouTube Live等のレギュラー配信`;

        const PROMPT_CONTACT = `
「{talent_name}」への問い合わせ先・コンタクト情報を検索してください。
※参考: 所属事務所は「{agency_name}」

検索: "{talent_name} 公式サイト" "{talent_name} 問い合わせ" "{talent_name} 出演依頼"

調べてほしいこと：
- 公式サイトのURL
- 公式サイトの問い合わせページURL
- 事務所の問い合わせ先
- 出演依頼・仕事の依頼先
- ファンレターの送り先（あれば）
- 公式メールアドレス（公開されていれば）

※公式サイト、事務所公式ページからの情報のみ報告してください。`;

        // JSON変換プロンプト
        const PROMPT_PARSE = `
以下の検索結果をJSON形式に整理してください。


- 公式情報のみを抽出してください
- ファンアカウント、非公式情報、同名別人の情報は含めないでください
- 不確かな情報はnullにしてください

【ジャンル判定 ← 最重要】
以下の基準で正確に分類してください（上から順にチェック）：

1. 公式に「アイドル」と名乗っている/アイドル活動がメイン
   → 女性のみ: "女性アイドルグループ" / 男性のみ: "男性アイドルグループ"
   → ソロ: "女性ソロアイドル" / "男性ソロアイドル"
   
2. バンド形態（メンバーが楽器を演奏）
   → 女性のみ: "ガールズバンド" / 男性または混合: "バンド" or "ロックバンド"
   
3. 作詞作曲を自分で行うソロ歌手 → "シンガーソングライター"

4. 声優業がメイン → "声優" or "声優アーティスト"

5. VTuber/バーチャル → "VTuber"

6. K-POPグループ → "K-POP"

7. ラップ/ヒップホップがメイン → "ヒップホップ"

8. 上記以外の歌手 → "アーティスト"

9. 歌わない → "俳優" / "女優" / "タレント" / "モデル"

※「アーティスト」は最後の手段。アイドルやバンドを見逃さないこと。
※複数該当する場合はメインの活動を優先

【SNSアカウントの確認 ← 最重要】
SNSアカウントは以下の条件をすべて満たす場合のみ記載してください：
- プロフィールに所属事務所名または本人名が明記されている
- 公式サイトからリンクされている、または認証バッジがある
- アカウント名やユーザー名が本人を示している
- 投稿内容が本人の活動と一致している

以下は絶対に含めないでください：
× ファンアカウント（「ファン」「推し」「応援」「まとめ」を含む）
× 同姓同名の別人（別事務所、別ジャンル、一般人）
× 更新停止中の古いアカウント
× 確認が取れないアカウント → nullにする

【ファン層について - 必ず埋めてください】
検索結果から直接的な情報がなくても、以下のルールで推測してください：

■ ジャンルからの推測ルール：
- 女性アイドルグループ → gender: "男性8割・女性2割", age: "20代後半〜30代が中心"
- 男性アイドルグループ → gender: "女性9割・男性1割", age: "10代後半〜20代が中心"
- ガールズバンド → gender: "女性6割・男性4割", age: "20代〜30代が中心"
- バンド・ロック系 → gender: "男女半々", age: "20代〜30代が中心"
- シンガーソングライター → gender: "男女半々", age: "20代〜30代が中心"
- 声優・アニソン系 → gender: "男性7割・女性3割", age: "20代後半〜30代が中心"
- 地下アイドル → gender: "男性9割・女性1割", age: "30代〜40代が中心"
- K-POP系 → gender: "女性8割・男性2割", age: "10代〜20代が中心"
- VTuber → gender: "男性8割・女性2割", age: "20代〜30代が中心"

■ 直接的な情報があれば、それを優先してください
■ 推測した場合は inference_basis に「ジャンルから推測」と記載

【リリースイベントについて】
- 特典内容（ブロマイド、生写真等）は必ず記載
- イベントページのURLは必ず記載
- URLが見つからない場合は情報源のサイト名を記載

# 検索結果
{search_results}

# 出力形式（このJSONのみ出力）
{
  "basic": {
    "name": "正式名称",
    "reading": "読み方",
    "type": "SOLO/GROUP",
    "start_year": "活動開始年",
    "agency": "所属事務所",
    "label": "レコード会社",
    "genre": "ジャンル（必ず以下から選択: 女性アイドルグループ/男性アイドルグループ/女性ソロアイドル/男性ソロアイドル/ガールズバンド/バンド/ロックバンド/シンガーソングライター/声優/声優アーティスト/VTuber/K-POP/ヒップホップ/アーティスト/俳優/女優/タレント/モデル）",
    "member_count": "メンバー人数（グループの場合、数字のみ）",
    "members": [
      {
        "name": "メンバー名",
        "birthday": "生年月日（YYYY-MM-DD形式またはMM月DD日）",
        "position": "担当・ポジション（ボーカル、ダンス、リーダー等）"
      }
    ],
    "history": "経歴・出演歴",
    "profile": "プロフィール概要"
  },
  "sns": {
    "twitter": { "url": "公式アカウントURL", "followers": "フォロワー数", "source": "情報源", "date": "確認日" },
    "youtube": { "url": "公式チャンネルURL", "subscribers": "登録者数", "source": "情報源", "date": "確認日" },
    "instagram": { "url": "公式アカウントURL", "followers": "フォロワー数", "source": "情報源", "date": "確認日" },
    "tiktok": { "url": "公式アカウントURL", "followers": "フォロワー数", "source": "情報源", "date": "確認日" },
    "other": "その他公式SNS"
  },
  "live": {
    "oneman": "ワンマン情報",
    "tour": "ツアー情報",
    "festival": "フェス出演",
    "summary": "活動まとめ"
  },
  "release": {
    "cd": "CD情報",
    "dvd_bd": "DVD/BD情報",
    "release_events": [
      {
        "date": "開催日（○年○月○日）",
        "time": "開始時間",
        "venue": "会場名（店舗名・施設名）",
        "location": "所在地（○○区、○○市等）",
        "event_type": "イベント種別（握手会/サイン会/チェキ会/お話し会/ミニライブ/複合等）",
        "content_detail": {
          "handshake": "握手会詳細（個別/全員/ミニ等）",
          "autograph": "サイン会詳細（サイン対象物）",
          "cheki": "チェキ会詳細（ソロ/2ショット/グループ等）",
          "talk": "お話し会詳細（1対1/グループ等）",
          "mini_live": "ミニライブ有無・曲数",
          "other": "その他（ハイタッチ、お見送り等）"
        },
        "target_product": "対象商品（CDタイトル名）",
        "regulation": {
          "quantity": "必要枚数（1枚で1回、2枚で1回等）",
          "distribution": "参加券配布方法（先着/抽選/整理番号/予約特典）",
          "time_limit": "時間制限（○秒、○分）",
          "age_limit": "年齢制限（なし/○歳以上）",
          "photo_allowed": "撮影可否（可/不可/スタッフ撮影のみ）",
          "gift_allowed": "プレゼント可否"
        },
        "benefits": {
          "purchase": "購入特典（生写真、ブロマイド、ポストカード等）",
          "purchase_detail": "特典詳細（サイズ、全○種、ランダム/選択等）",
          "store_tower": "タワレコ特典",
          "store_hmv": "HMV特典",
          "store_animate": "アニメイト特典",
          "store_amazon": "Amazon特典",
          "lottery": "応募抽選特典"
        },
        "url": "イベント詳細ページURL",
        "source": "情報源"
      }
    ]
  },
  "goods": {
    "ec_url": "公式ECサイトURL",
    "ec_name": "ショップ名",
    "ec_type": "EC形態（自社EC/BOOTH/BASE/STORES/楽天等）",
    "photo_goods": {
      "raw_photo": "生写真（価格、サイズ、ランダム/選択、全○種）",
      "bromide": "ブロマイド（価格、サイズ）",
      "cheki": "ランダムチェキ（価格）",
      "postcard": "ポストカード",
      "photobook": "写真集"
    },
    "apparel": {
      "tshirt": "Tシャツ（価格帯）",
      "hoodie": "パーカー",
      "towel": "タオル（種類）",
      "happi": "法被"
    },
    "support_goods": {
      "penlight": "ペンライト（価格、公式カラー）",
      "uchiwa": "うちわ",
      "fan_towel": "推しタオル"
    },
    "accessories": {
      "acrylic_stand": "アクスタ（価格、ランダム/選択）",
      "acrylic_keychain": "アクキー",
      "can_badge": "缶バッジ（サイズ、全○種）",
      "rubber_band": "ラバーバンド",
      "strap": "ストラップ"
    },
    "random_goods": {
      "exists": "ランダム商品の有無",
      "complete_cost": "全種コンプ目安金額"
    },
    "live_goods": {
      "venue_limited": "会場限定グッズ有無",
      "online_available": "通販対応"
    },
    "price_range": {
      "low": "低価格帯（〜1000円）の商品",
      "mid": "中価格帯（1000〜3000円）の商品",
      "high": "高価格帯（3000円〜）の商品"
    }
  },
  "fanclub": {
    "exists": true,
    "name": "FC名",
    "url": "公式FC URL",
    "price": "料金（月額/年額）",
    "join_benefit": "入会特典",
    "continue_benefit": "継続特典",
    "has_ec": true,
    "has_limited_event": "FC限定イベント有無"
  },
  "fans": {
    "gender": "性別比（例：男性7割・女性3割、ほぼ女性、男女半々）",
    "age": "年齢層（例：20代後半〜30代前半が中心）",
    "region": "地域分布（例：首都圏中心、全国的）",
    "nickname": "ファンの呼称（例：○○推し、○○民）",
    "characteristics": "ファン層の特徴・傾向",
    "inference_basis": "推測根拠（どの情報源から判断したか）"
  },
  "online": {
    "exists": true,
    "platform": "プラットフォーム（WithLIVE/talkport/SHOWROOM等）",
    "price": "料金体系（1枠○円、○秒○円等）",
    "frequency": "開催頻度（毎週/月○回/不定期）",
    "participation": "参加方法（CD購入/チケット購入/抽選）",
    "limista": "limista利用経験あり/なし/不明",
    "limista_history": "limista.comでの開催履歴（日時と内容）"
  },
  "news": {
    "recent": "直近のニュース・話題",
    "upcoming": "今後の予定・発表",
    "sns_topics": "SNSで話題になっていること"
  },
  "contact": {
    "official": "公式サイト",
    "inquiry": "問い合わせURL",
    "email": "メール",
    "other": "その他"
  }
}
※情報がない項目はnull ※JSONのみ出力`;

        // クイック検索用の軽量パースプロンプト
        const PROMPT_PARSE_QUICK = `
検索結果をJSON形式に整理。公式情報のみ、不確かな情報はnull。

【ジャンル】女性アイドルグループ/男性アイドルグループ/女性ソロアイドル/男性ソロアイドル/ガールズバンド/バンド/シンガーソングライター/声優/VTuber/K-POP/アーティスト/俳優/タレント から選択

【SNS】公式のみ記載。ファンアカウント、同名別人は除外。

# 検索結果
{search_results}

# 出力（JSONのみ）
{
  "basic": {
    "name": "正式名称",
    "reading": "読み",
    "type": "SOLO/GROUP",
    "agency": "事務所",
    "label": "レコード会社",
    "genre": "ジャンル",
    "member_count": "人数",
    "profile": "概要"
  },
  "sns": {
    "twitter": { "url": "URL", "followers": "フォロワー数" },
    "youtube": { "url": "URL", "subscribers": "登録者数" },
    "instagram": { "url": "URL", "followers": "フォロワー数" },
    "tiktok": { "url": "URL", "followers": "フォロワー数" }
  },
  "fans": {
    "gender": "性別比",
    "age": "年齢層"
  }
}`;

        // ====== API Helpers ======
        const cleanJson = (text) => {
            if (!text) throw new Error('Empty');
            let s = text.trim();
            
            // マークダウンのコードブロックを除去
            const m = s.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
            if (m) s = m[1].trim();
            
            // JSONの範囲を抽出
            const f = s.indexOf('{'), l = s.lastIndexOf('}');
            if (f === -1 || l === -1) throw new Error('No JSON');
            s = s.substring(f, l + 1);
            
            // 全ての改行・タブを一旦スペースに（最も安全）
            s = s.replace(/[\n\r\t]+/g, ' ');
            
            // 連続スペースを1つに
            s = s.replace(/  +/g, ' ');
            
            // 末尾のカンマを除去
            s = s.replace(/,(\s*[}\]])/g, '$1');
            
            // 制御文字を除去
            s = s.replace(/[\x00-\x1F\x7F]/g, '');
            
            try {
                return JSON.parse(s);
            } catch (e) {
                console.error('JSON parse error:', e.message);
                console.error('Problematic JSON:', s.substring(0, 300));
                throw new Error(`JSON parse failed: ${e.message}`);
            }
        };

        let updateUsage = null;

        const callApi = async (target, payload, timeoutMs = 60000) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeoutMs);
            
            try {
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target, payload }),
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                
                if (!res.ok) {
                    const text = await res.text();
                    console.error('API Error:', res.status, text);
                    throw new Error(`Error: ${res.status} - ${text.substring(0, 100)}`);
                }
                const data = await res.json();
                if (updateUsage) {
                    let u = { prompt_tokens: 0, completion_tokens: 0 };
                    if (target === 'gemini' && data.usageMetadata) {
                        u.prompt_tokens = data.usageMetadata.promptTokenCount || 0;
                        u.completion_tokens = data.usageMetadata.candidatesTokenCount || 0;
                    }
                    if ((target === 'openai' || target === 'perplexity') && data.usage) {
                        u = data.usage;
                    }
                    updateUsage(target, u);
                }
                if (target === 'gemini') return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                return data.choices?.[0]?.message?.content || '';
            } catch (e) {
                clearTimeout(timeoutId);
                if (e.name === 'AbortError') {
                    throw new Error('タイムアウト（60秒）');
                }
                throw e;
            }
        };

        const searchPerplexity = async (prompt) => callApi('perplexity', {
            model: "sonar-pro",
            messages: [
                { role: "system", content: `あなたは芸能データ調査のプロフェッショナルです。
現在の日時は ${new Date().toLocaleDateString('ja-JP')} です。

以下のルールを厳守してください：
1. **情報源の厳選**: 公式サイト、大手ニュースメディア、信頼できるデータベースのみを根拠にしてください。
2. **文脈の固定**: 必ず指定された「所属事務所」のタレントであることを確認してください。同名の別人は除外してください。
3. **推測の禁止**: 事実に基づかない推測は行わず、不明な場合は「情報なし」と回答してください。
4. **ファン層について**: ライブレポート、SNSの傾向、グッズの種類などから客観的に分析してください。` },
                { role: "user", content: prompt }
            ],
            temperature: 0.1
        });

        // 安いモデル用検索（補助的な情報用）- コスト1/5
        const searchPerplexityLight = async (prompt) => callApi('perplexity', {
            model: "sonar",
            messages: [
                { role: "system", content: `あなたは芸能情報の調査員です。指定されたタレントについて検索し、見つかった情報を報告してください。` },
                { role: "user", content: prompt }
            ],
            temperature: 0.1
        });

        // SNS専用検索（シンプル版）
        const searchSNS = async (prompt) => callApi('perplexity', {
            model: "sonar-pro",
            messages: [
                { role: "system", content: `あなたはSNS情報の調査専門家です。
アーティストやタレントの公式SNSアカウント（Twitter/X、YouTube、Instagram、TikTok）のURLとフォロワー数を調べてください。

【重要な確認事項】
- プロフィールに所属事務所名が記載されているか確認
- 認証バッジ（青いチェックマーク）があるか確認
- 公式サイトからリンクされているか確認
- ファンアカウント、まとめアカウント、同名別人は絶対に除外

確認が取れないアカウントは報告しないでください。` },
                { role: "user", content: prompt }
            ],
            temperature: 0.1
        });

        // YouTube Data API - チャンネル登録者数を取得
        const getYouTubeStats = async (youtubeUrl) => {
            if (!youtubeUrl) return null;
            try {
                // URLからチャンネル情報を抽出
                let payload = {};
                const urlStr = String(youtubeUrl);
                
                // @handle形式: youtube.com/@xxxxx
                const handleMatch = urlStr.match(/youtube\.com\/@([^\/\?\s]+)/);
                if (handleMatch) {
                    payload = { handle: handleMatch[1] };
                }
                
                // channel/ID形式: youtube.com/channel/UCxxxxx
                const channelMatch = urlStr.match(/youtube\.com\/channel\/([^\/\?\s]+)/);
                if (channelMatch) {
                    payload = { channelId: channelMatch[1] };
                }
                
                // user形式: youtube.com/user/xxxxx
                const userMatch = urlStr.match(/youtube\.com\/user\/([^\/\?\s]+)/);
                if (userMatch) {
                    payload = { username: userMatch[1] };
                }
                
                // c/形式: youtube.com/c/xxxxx（handleとして検索）
                const cMatch = urlStr.match(/youtube\.com\/c\/([^\/\?\s]+)/);
                if (cMatch) {
                    payload = { handle: cMatch[1] };
                }
                
                if (Object.keys(payload).length === 0) {
                    console.log('YouTube URL format not recognized:', urlStr);
                    return null;
                }
                
                console.log('YouTube API request:', payload);
                
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'youtube', payload })
                });
                
                if (!res.ok) {
                    console.warn('YouTube API error:', res.status);
                    return null;
                }
                
                const data = await res.json();
                console.log('YouTube API response:', data);
                
                if (data.success && data.subscriberCount) {
                    return {
                        channelId: data.channelId,
                        title: data.title,
                        subscriberCount: data.subscriberCount,
                        subscriberCountFormatted: formatSubscriberCount(data.subscriberCount),
                        viewCount: data.viewCount,
                        videoCount: data.videoCount,
                        source: 'YouTube Data API',
                        fetchedAt: new Date().toLocaleString('ja-JP')
                    };
                }
                console.warn('YouTube API: No subscriber count found', data);
                return null;
            } catch (e) {
                console.warn('YouTube API error:', e);
                return null;
            }
        };

        // タレント名でYouTubeチャンネルを検索
        const searchYouTubeByName = async (talentName) => {
            if (!talentName) return null;
            try {
                console.log('YouTube search by name:', talentName);
                
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'youtube', payload: { searchQuery: talentName } })
                });
                
                if (!res.ok) {
                    console.warn('YouTube search error:', res.status);
                    return null;
                }
                
                const data = await res.json();
                console.log('YouTube search response:', data);
                
                if (data.success && data.subscriberCount) {
                    return {
                        channelId: data.channelId,
                        title: data.title,
                        url: `https://www.youtube.com/channel/${data.channelId}`,
                        subscriberCount: data.subscriberCount,
                        subscriberCountFormatted: formatSubscriberCount(data.subscriberCount),
                        viewCount: data.viewCount,
                        videoCount: data.videoCount,
                        source: 'YouTube Data API',
                        fetchedAt: new Date().toLocaleString('ja-JP'),
                        candidates: data.candidates
                    };
                }
                return null;
            } catch (e) {
                console.warn('YouTube search error:', e);
                return null;
            }
        };

        // Twitter API - ユーザー名からフォロワー数を取得
        const getTwitterStats = async (twitterUrl) => {
            if (!twitterUrl) return null;
            try {
                const urlStr = String(twitterUrl);
                // URLからユーザー名を抽出
                const match = urlStr.match(/(?:twitter\.com|x\.com)\/(@?[^\/\?\s]+)/i);
                if (!match) {
                    console.log('Twitter URL format not recognized:', urlStr);
                    return null;
                }
                
                let username = match[1];
                // @を除去、intent/userなどの特殊パスを除外
                if (username === 'intent' || username === 'i' || username === 'search' || username === 'hashtag') {
                    return null;
                }
                username = username.replace(/^@/, '');
                
                console.log('Twitter API request:', username);
                
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'twitter', payload: { username } })
                });
                
                if (!res.ok) {
                    console.warn('Twitter API error:', res.status);
                    return null;
                }
                
                const data = await res.json();
                console.log('Twitter API response:', data);
                
                if (data.success && data.followers_count !== null) {
                    return {
                        id: data.id,
                        username: data.username,
                        name: data.name,
                        followersCount: data.followers_count,
                        followersCountFormatted: formatFollowerCount(data.followers_count),
                        verified: data.verified,
                        source: 'Twitter API',
                        fetchedAt: new Date().toLocaleString('ja-JP')
                    };
                }
                console.warn('Twitter API: No data found', data);
                return null;
            } catch (e) {
                console.warn('Twitter API error:', e);
                return null;
            }
        };

        // タレント名でTwitterユーザーを検索
        const searchTwitterByName = async (talentName) => {
            if (!talentName) return null;
            try {
                console.log('Twitter search by name:', talentName);
                
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'twitter', payload: { searchQuery: talentName + ' 公式' } })
                });
                
                if (!res.ok) {
                    console.warn('Twitter search error:', res.status);
                    return null;
                }
                
                const data = await res.json();
                console.log('Twitter search response:', data);
                
                if (data.success && data.followers_count !== null) {
                    return {
                        id: data.id,
                        username: data.username,
                        name: data.name,
                        url: `https://x.com/${data.username}`,
                        followersCount: data.followers_count,
                        followersCountFormatted: formatFollowerCount(data.followers_count),
                        verified: data.verified,
                        source: 'Twitter API',
                        fetchedAt: new Date().toLocaleString('ja-JP'),
                        candidates: data.candidates
                    };
                }
                return null;
            } catch (e) {
                console.warn('Twitter search error:', e);
                return null;
            }
        };

        // フォロワー数をフォーマット（例: 1234567 → "123.4万"）
        const formatFollowerCount = (count) => {
            if (!count && count !== 0) return null;
            const num = parseInt(count, 10);
            if (isNaN(num)) return count;
            if (num >= 10000) {
                return (num / 10000).toFixed(1).replace(/\.0$/, '') + '万';
            }
            return num.toLocaleString();
        };

        // CD情報検索API
        const searchCDInfo = async (artistName) => {
            if (!artistName) return null;
            try {
                console.log('CD search:', artistName);
                
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'cd_search', payload: { artist: artistName } })
                });
                
                if (!res.ok) {
                    console.warn('CD API error:', res.status);
                    return null;
                }
                
                const data = await res.json();
                console.log('CD API response:', data);
                
                if (data.success && data.items && data.items.length > 0) {
                    return {
                        count: data.count,
                        items: data.items,
                        source: 'CD流通API',
                        fetchedAt: new Date().toLocaleString('ja-JP')
                    };
                }
                return null;
            } catch (e) {
                console.warn('CD API error:', e);
                return null;
            }
        };

        // Spotify API - アーティスト情報を取得
        const searchSpotify = async (artistName) => {
            if (!artistName) return null;
            try {
                console.log('Spotify search:', artistName);
                
                const res = await fetch(PROXY_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ target: 'spotify', payload: { artist: artistName } })
                });
                
                const data = await res.json();
                console.log('Spotify API response:', data);
                
                // APIキー未設定の場合はスキップ
                if (data.skipped) {
                    console.log('Spotify API skipped (not configured)');
                    return null;
                }
                
                if (data.success) {
                    return {
                        id: data.id,
                        name: data.name,
                        followers: data.followers,
                        followersFormatted: formatFollowerCount(data.followers),
                        popularity: data.popularity,
                        genres: data.genres,
                        images: data.images,
                        external_url: data.external_url,
                        top_tracks: data.top_tracks,
                        source: 'Spotify API',
                        fetchedAt: new Date().toLocaleString('ja-JP')
                    };
                }
                return null;
            } catch (e) {
                console.warn('Spotify API error:', e);
                return null;
            }
        };

        // 登録者数をフォーマット（例: 1234567 → "123.4万人"）
        const formatSubscriberCount = (count) => {
            if (!count) return null;
            const num = parseInt(count, 10);
            if (isNaN(num)) return count;
            if (num >= 10000) {
                return (num / 10000).toFixed(1).replace(/\.0$/, '') + '万人';
            }
            return num.toLocaleString() + '人';
        };

        // OpenAIでJSONパース（GPT-4o-mini）
        const parseOpenAI = async (prompt) => {
            const text = await callApi('openai', {
                model: "gpt-4o-mini",
                messages: [
                    { role: "system", content: "あなたはデータ整形の専門家です。与えられた情報をJSON形式に変換してください。必ずJSON形式のみ出力し、説明文は不要です。" },
                    { role: "user", content: prompt }
                ],
                temperature: 0.1,
                max_tokens: 4000
            });
            return cleanJson(text);
        };

        const searchPerplexityJson = async (prompt) => {
            const text = await callApi('perplexity', {
                model: "sonar-pro",
                messages: [{ role: "system", content: "JSON形式のみで回答。" }, { role: "user", content: prompt }],
                temperature: 0.1
            });
            return cleanJson(text);
        };

        // ====== Components ======
        // 値を見やすく整形
        const stringify = (val) => {
            if (val === null || val === undefined) return null;
            if (typeof val === 'string') return val;
            if (typeof val === 'number' || typeof val === 'boolean') return String(val);
            if (Array.isArray(val)) {
                // 配列は改行区切りで表示
                return val.map((item, i) => {
                    if (typeof item === 'object' && item !== null) {
                        // オブジェクトの配列は各項目を整形
                        return Object.entries(item)
                            .filter(([k, v]) => v !== null && v !== undefined && v !== '')
                            .map(([k, v]) => `${k}: ${typeof v === 'object' ? JSON.stringify(v) : v}`)
                            .join(' / ');
                    }
                    return String(item);
                }).join('\n');
            }
            if (typeof val === 'object') {
                // オブジェクトはキー: 値形式で表示
                const entries = Object.entries(val)
                    .filter(([k, v]) => v !== null && v !== undefined && v !== '');
                if (entries.length === 0) return null;
                return entries.map(([k, v]) => {
                    if (typeof v === 'object' && v !== null) {
                        if (Array.isArray(v)) {
                            return `${k}: ${v.join(', ')}`;
                        }
                        return `${k}: ${Object.entries(v).map(([k2, v2]) => `${k2}=${v2}`).join(', ')}`;
                    }
                    return `${k}: ${v}`;
                }).join('\n');
            }
            return String(val);
        };
        
        // URLを抽出（オブジェクトの場合）
        const extractUrl = (val) => {
            if (!val) return null;
            if (typeof val === 'string' && val.startsWith('http')) return val;
            if (typeof val === 'object' && val.url) return extractUrl(val.url);
            return null;
        };

        const Section = ({ title, children }) => (
            <div className="mb-4">
                <h4 className="text-xs font-bold text-slate-500 uppercase tracking-wide border-b pb-1 mb-2">{title}</h4>
                {children}
            </div>
        );

        const Row = ({ label, value, url }) => {
            const strVal = stringify(value);
            if (!strVal && !url) return null;
            return (
                <div className="flex py-1 text-sm">
                    <span className="text-slate-500 w-28 shrink-0">{label}</span>
                    {url && url.startsWith('http') ? (
                        <a href={url} target="_blank" rel="noopener" className="text-blue-600 hover:underline truncate">{strVal || url}</a>
                    ) : <span className="text-slate-800 whitespace-pre-wrap">{strVal}</span>}
                </div>
            );
        };

        const Text = ({ text }) => {
            if (text === null || text === undefined) return <span className="text-slate-400 text-sm">-</span>;
            
            // 配列の場合は箇条書き
            if (Array.isArray(text)) {
                if (text.length === 0) return <span className="text-slate-400 text-sm">-</span>;
                return (
                    <ul className="text-sm text-slate-700 space-y-1">
                        {text.map((item, i) => (
                            <li key={i} className="pl-2 border-l-2 border-slate-200">
                                {typeof item === 'object' && item !== null ? (
                                    <span>
                                        {Object.entries(item)
                                            .filter(([k, v]) => v !== null && v !== undefined && v !== '')
                                            .map(([k, v], j) => (
                                                <span key={k}>
                                                    {j > 0 && ' / '}
                                                    <span className="text-slate-500">{k}:</span> {typeof v === 'object' ? JSON.stringify(v) : String(v)}
                                                </span>
                                            ))}
                                    </span>
                                ) : String(item)}
                            </li>
                        ))}
                    </ul>
                );
            }
            
            // オブジェクトの場合
            if (typeof text === 'object' && text !== null) {
                const entries = Object.entries(text).filter(([k, v]) => v !== null && v !== undefined && v !== '');
                if (entries.length === 0) return <span className="text-slate-400 text-sm">-</span>;
                return (
                    <div className="text-sm text-slate-700 space-y-1">
                        {entries.map(([k, v]) => (
                            <div key={k} className="pl-2 border-l-2 border-slate-200">
                                <span className="text-slate-500">{k}:</span>{' '}
                                {typeof v === 'object' ? (
                                    Array.isArray(v) ? v.join(', ') : 
                                    Object.entries(v).map(([k2, v2]) => `${k2}: ${v2}`).join(', ')
                                ) : String(v)}
                            </div>
                        ))}
                    </div>
                );
            }
            
            // 文字列の場合
            const strVal = String(text);
            if (!strVal) return <span className="text-slate-400 text-sm">-</span>;
            return <p className="text-sm text-slate-700 whitespace-pre-wrap">{strVal}</p>;
        };

        const Link = ({ url, label }) => {
            const strUrl = extractUrl(url) || stringify(url);
            if (!strUrl || !strUrl.startsWith('http')) return null;
            return (
                <a href={strUrl} target="_blank" rel="noopener" className="inline-block px-3 py-1 text-xs bg-slate-100 rounded hover:bg-slate-200 mr-2 mb-2">{label}</a>
            );
        };

        // タレントカード
        const TalentCard = ({ data, result, onUpdate, onDetailSearch }) => {
            const r = result || {};
            const b = r.basic || {};
            const s = r.sns || {};
            const l = r.live || {};
            const rel = r.release || {};
            const g = r.goods || {};
            const fc = r.fanclub || {};
            const f = r.fans || {};
            const o = r.online || {};
            const news = r.news || {};
            const c = r.contact || {};
            const raw = r._raw || {};
            const parseError = r._parseError;
            const rawAll = r._rawAll;
            const fetchedAt = r._fetchedAt;
            const cacheHits = r._cacheHits || 0;
            const searchCount = r._searchCount || 0;
            const detailSearched = r._detailSearched || false;
            
            // 追加調査用のstate
            const [showAdditional, setShowAdditional] = useState(false);
            const [additionalPrompt, setAdditionalPrompt] = useState('');
            const [additionalResult, setAdditionalResult] = useState(r._additionalResults || []);
            const [searching, setSearching] = useState(false);
            
            const talentName = stringify(b.name) || data?.name;
            const agency = stringify(b.agency) || '';
            
            // 追加調査を実行
            const runAdditionalSearch = async () => {
                if (!additionalPrompt.trim()) return;
                setSearching(true);
                try {
                    const prompt = additionalPrompt
                        .replace(/{name}/g, talentName)
                        .replace(/{agency}/g, agency);
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            target: 'perplexity',
                            payload: {
                                model: "sonar-pro",
                                messages: [
                                    { role: "system", content: `「${talentName}」（${agency}所属）についての追加調査です。公式情報のみを報告してください。` },
                                    { role: "user", content: prompt }
                                ],
                                temperature: 0.1
                            }
                        })
                    });
                    const data = await res.json();
                    const text = data.choices?.[0]?.message?.content || 'エラー';
                    const newResult = {
                        prompt: additionalPrompt,
                        result: text,
                        time: new Date().toLocaleString('ja-JP')
                    };
                    setAdditionalResult(prev => [...prev, newResult]);
                    setAdditionalPrompt('');
                } catch (e) {
                    setAdditionalResult(prev => [...prev, { prompt: additionalPrompt, result: `エラー: ${e.message}`, time: new Date().toLocaleString('ja-JP') }]);
                }
                setSearching(false);
            };
            
            // データが空かどうかチェック（文字列またはオブジェクトがあればOK）
            const hasData = !!(b.name || b.agency || s.twitter?.url || 
                (typeof b === 'object' && Object.keys(b).some(k => b[k] !== null && b[k] !== undefined)));

            return (
                <div className="bg-white rounded-lg shadow-sm border overflow-hidden">
                    <div className="p-4 border-b bg-slate-50">
                        <div className="flex justify-between items-start">
                            <div>
                                <h3 className="font-bold text-lg">{stringify(b.name) || data?.name}</h3>
                                {b.reading && <p className="text-xs text-slate-400">{stringify(b.reading)}</p>}
                            </div>
                            <div className="flex items-center gap-2">
                                {/* 詳細ボタン（クイック後のみ表示） */}
                                {!detailSearched && onDetailSearch && (
                                    <button 
                                        onClick={() => onDetailSearch(data?.id)} 
                                        className="text-xs bg-slate-100 text-slate-600 px-3 py-1 rounded hover:bg-slate-200 font-medium"
                                    >
                                        詳細
                                    </button>
                                )}
                                {detailSearched && (
                                    <span className="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded">
                                        詳細済
                                    </span>
                                )}
                                {fetchedAt && <span className="text-xs text-slate-400">取得: {fetchedAt}</span>}
                                {cacheHits > 0 && (
                                    <span className="text-xs text-slate-400">
                                        (キャッシュ{cacheHits}/検索{searchCount})
                                    </span>
                                )}
                            </div>
                        </div>
                        {b.profile && <p className="text-sm text-slate-600 mt-1">{stringify(b.profile)}</p>}
                        {parseError && (
                            <div className="mt-2 p-2 bg-slate-50 border border-slate-200 rounded text-xs text-slate-600">
                                データ整形エラー: {parseError}
                            </div>
                        )}
                    </div>

                    <div className="p-4 space-y-4">
                        {/* パースエラー時または空データ時は検索結果を直接表示 */}
                        {(parseError || !hasData) && Object.keys(raw).length > 0 && (
                            <div className="bg-slate-50 border border-slate-200 rounded p-3">
                                <div className="text-xs font-medium text-slate-600 mb-2">検索結果（生データ）</div>
                                {Object.entries(raw).map(([key, val]) => (
                                    <details key={key} className="mb-2" open>
                                        <summary className="text-sm font-medium text-slate-700 cursor-pointer">{key}</summary>
                                        <pre className="text-xs text-slate-700 whitespace-pre-wrap mt-1 bg-white p-2 rounded max-h-60 overflow-y-auto">{val}</pre>
                                    </details>
                                ))}
                            </div>
                        )}
                        
                        {/* 以下は正常にパースできた場合のみ表示 */}
                        {hasData && (
                            <>
                                <Section title="基本情報">
                                    <Row label="所属事務所" value={b.agency} />
                                    <Row label="レーベル" value={b.label} />
                                    <Row label="活動開始" value={b.start_year} />
                                    <Row label="ジャンル" value={b.genre} />
                                    {b.member_count && <Row label="メンバー数" value={`${b.member_count}人`} />}
                                    {/* メンバー詳細（配列の場合） */}
                                    {Array.isArray(b.members) && b.members.length > 0 && (
                                        <div className="mt-2">
                                            <div className="text-xs text-slate-500 mb-1">メンバー:</div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-xs border-collapse">
                                                    <thead>
                                                        <tr className="bg-slate-100">
                                                            <th className="text-left p-1 border">名前</th>
                                                            <th className="text-left p-1 border">生年月日</th>
                                                            <th className="text-left p-1 border">担当</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {b.members.map((m, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="p-1 border font-medium">{m.name || '-'}</td>
                                                                <td className="p-1 border">{m.birthday || '-'}</td>
                                                                <td className="p-1 border text-slate-600">{m.position || '-'}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    )}
                                    {/* メンバー（文字列の場合） */}
                                    {!Array.isArray(b.members) && b.members && (
                                        <Row label="メンバー" value={b.members} />
                                    )}
                                </Section>

                                {b.history && <Section title="経歴・出演歴"><Text text={b.history} /></Section>}

                                <Section title="SNS">
                                    {[
                                        { k: 'twitter', n: 'Twitter/X', f: 'followers' },
                                        { k: 'youtube', n: 'YouTube', f: 'subscribers' },
                                        { k: 'instagram', n: 'Instagram', f: 'followers' },
                                        { k: 'tiktok', n: 'TikTok', f: 'followers' },
                                        { k: 'twitch', n: 'Twitch', f: 'followers' }
                                    ].map(x => {
                                        const snsData = s[x.k];
                                        if (!snsData) return null;
                                        // URL抽出
                                        let url = null;
                                        if (typeof snsData === 'string' && snsData.startsWith('http')) {
                                            url = snsData;
                                        } else if (typeof snsData === 'object') {
                                            url = extractUrl(snsData.url) || extractUrl(snsData);
                                        }
                                        // フォロワー数抽出
                                        let count = null;
                                        if (typeof snsData === 'object') {
                                            count = snsData[x.f] || snsData.followers || snsData.subscribers || snsData.count;
                                        }
                                        // 情報源と日付
                                        const source = snsData?.source;
                                        const date = snsData?.date;
                                        // YouTubeチャンネルタイトル
                                        const channelTitle = snsData?.channelTitle;
                                        if (!url && !count) return null;
                                        return (
                                            <div key={x.k} className="py-2 px-3 bg-slate-50 rounded mb-1">
                                                <div className="flex justify-between items-start">
                                                    <div>
                                                        {url ? (
                                                            <a href={url} target="_blank" className="text-blue-600 hover:underline text-sm">{x.n}</a>
                                                        ) : (
                                                            <span className="text-slate-600 text-sm">{x.n}</span>
                                                        )}
                                                        {channelTitle && <div className="text-xs text-slate-500">{channelTitle}</div>}
                                                    </div>
                                                    <span className="font-bold text-sm">{stringify(count) || '-'}</span>
                                                </div>
                                                {(source || date) && (
                                                    <div className="text-xs text-slate-400 mt-1">
                                                        {source && <span className="bg-slate-100 text-slate-600 px-1 rounded">{stringify(source)}</span>}
                                                        {date && <span className="ml-2">{stringify(date)}</span>}
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                    {s.other && <div className="mt-2"><Text text={s.other} /></div>}
                                </Section>

                                {/* Spotify情報 */}
                                {r.spotify && (
                                    <Section title="Spotify">
                                        <div className="p-3 bg-slate-50 rounded border border-slate-200">
                                            <div className="flex justify-between items-start mb-2">
                                                <div>
                                                    <a href={r.spotify.external_url} target="_blank" rel="noopener" className="text-slate-600 font-medium hover:underline">
                                                        🎵 {r.spotify.name}
                                                    </a>
                                                    {r.spotify.genres && r.spotify.genres.length > 0 && (
                                                        <div className="text-xs text-slate-500 mt-1">
                                                            {r.spotify.genres.slice(0, 3).join(', ')}
                                                        </div>
                                                    )}
                                                </div>
                                                <div className="text-right">
                                                    <div className="font-bold text-slate-600">{r.spotify.followersFormatted}</div>
                                                    <div className="text-xs text-slate-500">フォロワー</div>
                                                </div>
                                            </div>
                                            <div className="flex items-center gap-3 text-xs mb-2">
                                                <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded">
                                                    人気度: {r.spotify.popularity}/100
                                                </span>
                                                <span className="text-slate-400">{r.spotify.source} / {r.spotify.fetchedAt}</span>
                                            </div>
                                            {r.spotify.top_tracks && r.spotify.top_tracks.length > 0 && (
                                                <details className="mt-2">
                                                    <summary className="text-xs font-medium text-slate-600 cursor-pointer hover:text-slate-800">
                                                        🎶 人気曲TOP5
                                                    </summary>
                                                    <div className="mt-1 space-y-1">
                                                        {r.spotify.top_tracks.map((track, idx) => (
                                                            <div key={idx} className="text-xs flex justify-between items-center py-1 border-b border-slate-100">
                                                                <div>
                                                                    <span className="text-slate-400 mr-2">{idx + 1}.</span>
                                                                    <a href={track.external_url} target="_blank" rel="noopener" className="text-slate-600 hover:underline">
                                                                        {track.name}
                                                                    </a>
                                                                    <span className="text-slate-400 ml-2">({track.album})</span>
                                                                </div>
                                                                <span className="text-slate-400">{track.release_date}</span>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </details>
                                            )}
                                        </div>
                                    </Section>
                                )}

                                <Section title={`ライブ活動（${YEAR_RANGE_SHORT}）`}>
                                    {l.oneman && <div className="mb-2"><span className="text-xs text-slate-500">ワンマン:</span><Text text={l.oneman} /></div>}
                                    {l.tour && <div className="mb-2"><span className="text-xs text-slate-500">ツアー:</span><Text text={l.tour} /></div>}
                                    {l.festival && <div className="mb-2"><span className="text-xs text-slate-500">フェス:</span><Text text={l.festival} /></div>}
                                    {l.summary && <p className="text-sm bg-slate-50 p-2 rounded">{stringify(l.summary)}</p>}
                                </Section>

                                <Section title={`リリース（${YEAR_RANGE_SHORT}）`}>
                                    {rel.cd && <div className="mb-2"><span className="text-xs text-slate-500">CD:</span><Text text={rel.cd} /></div>}
                                    {rel.dvd_bd && <div className="mb-2"><span className="text-xs text-slate-500">DVD/BD:</span><Text text={rel.dvd_bd} /></div>}
                                </Section>

                                {/* 特典会・リリイベ - 重要情報として独立表示 */}
                                {rel.release_events && (
                                    <Section title="特典会・リリイベ">
                                        <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                            {Array.isArray(rel.release_events) && rel.release_events.length > 0 ? (
                                                <div className="space-y-4">
                                                    {rel.release_events.map((ev, idx) => (
                                                        <div key={idx} className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                                                            {/* イベントヘッダー */}
                                                            <div className="bg-slate-100 p-3 border-b border-slate-200">
                                                                <div className="font-bold text-slate-800 text-sm">
                                                                    {ev.date && stringify(ev.date)}
                                                                    {ev.venue && <span className="ml-2 text-slate-600">@ {stringify(ev.venue)}</span>}
                                                                </div>
                                                                {ev.event_type && <div className="text-xs text-slate-600 mt-1">種別: {stringify(ev.event_type)}</div>}
                                                            </div>
                                                            
                                                            <div className="p-3 space-y-3">
                                                                {/* 特典会の内容 */}
                                                                {(ev.content || ev.content_detail) && (
                                                                    <div className="bg-slate-50 rounded-lg p-2">
                                                                        <div className="text-xs font-bold text-slate-700 mb-1">特典会の内容</div>
                                                                        {ev.content && <div className="text-sm text-slate-700">{stringify(ev.content)}</div>}
                                                                        {ev.content_detail && typeof ev.content_detail === 'object' && (
                                                                            <div className="mt-2 grid grid-cols-2 gap-1 text-xs">
                                                                                {ev.content_detail.handshake && <div><span className="text-slate-500">握手会:</span> {stringify(ev.content_detail.handshake)}</div>}
                                                                                {ev.content_detail.autograph && <div><span className="text-slate-500">サイン会:</span> {stringify(ev.content_detail.autograph)}</div>}
                                                                                {ev.content_detail.cheki && <div><span className="text-slate-500">チェキ会:</span> {stringify(ev.content_detail.cheki)}</div>}
                                                                                {ev.content_detail.talk && <div><span className="text-slate-500">お話し会:</span> {stringify(ev.content_detail.talk)}</div>}
                                                                                {ev.content_detail.mini_live && <div><span className="text-slate-500">ミニライブ:</span> {stringify(ev.content_detail.mini_live)}</div>}
                                                                                {ev.content_detail.other && <div><span className="text-slate-500">その他:</span> {stringify(ev.content_detail.other)}</div>}
                                                                            </div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                
                                                                {/* レギュレーション（参加条件）*/}
                                                                {(ev.regulation || ev.target_product || ev.time_limit) && (
                                                                    <div className="bg-slate-100 rounded-lg p-2 border border-slate-300">
                                                                        <div className="text-xs font-bold text-slate-700 mb-1">レギュレーション（参加条件）</div>
                                                                        <div className="text-sm space-y-1">
                                                                            {ev.target_product && (
                                                                                <div><span className="text-slate-600 font-medium">対象商品:</span> <span className="text-slate-700">{stringify(ev.target_product)}</span></div>
                                                                            )}
                                                                            {typeof ev.regulation === 'object' ? (
                                                                                <div className="grid grid-cols-2 gap-1 text-xs mt-1">
                                                                                    {ev.regulation.quantity && <div><span className="text-slate-500">必要枚数:</span> <span className="font-medium">{stringify(ev.regulation.quantity)}</span></div>}
                                                                                    {ev.regulation.distribution && <div><span className="text-slate-500">配布方法:</span> {stringify(ev.regulation.distribution)}</div>}
                                                                                    {ev.regulation.time_limit && <div><span className="text-slate-500">時間制限:</span> <span className="font-medium text-slate-600">{stringify(ev.regulation.time_limit)}</span></div>}
                                                                                    {ev.regulation.age_limit && <div><span className="text-slate-500">年齢制限:</span> {stringify(ev.regulation.age_limit)}</div>}
                                                                                    {ev.regulation.photo_allowed && <div><span className="text-slate-500">撮影:</span> {stringify(ev.regulation.photo_allowed)}</div>}
                                                                                    {ev.regulation.gift_allowed && <div><span className="text-slate-500">プレゼント:</span> {stringify(ev.regulation.gift_allowed)}</div>}
                                                                                </div>
                                                                            ) : ev.regulation && (
                                                                                <div><span className="text-slate-600 font-medium">条件:</span> <span className="text-slate-700">{stringify(ev.regulation)}</span></div>
                                                                            )}
                                                                            {ev.time_limit && !ev.regulation?.time_limit && (
                                                                                <div><span className="text-slate-600 font-medium">時間制限:</span> <span className="text-slate-600 font-medium">{stringify(ev.time_limit)}</span></div>
                                                                            )}
                                                                        </div>
                                                                    </div>
                                                                )}
                                                                
                                                                {/* 特典内容 */}
                                                                {ev.benefits && (
                                                                    <div className="bg-slate-50 rounded-lg p-2 border border-slate-200">
                                                                        <div className="text-xs font-bold text-slate-700 mb-1">特典内容</div>
                                                                        {typeof ev.benefits === 'object' ? (
                                                                            <div className="text-xs space-y-1">
                                                                                {ev.benefits.purchase && <div><span className="text-slate-600 font-medium">購入特典:</span> {stringify(ev.benefits.purchase)}</div>}
                                                                                {ev.benefits.purchase_detail && <div className="text-slate-500 ml-2">{stringify(ev.benefits.purchase_detail)}</div>}
                                                                                {ev.benefits.store_tower && <div><span className="text-slate-600">タワレコ特典:</span> {stringify(ev.benefits.store_tower)}</div>}
                                                                                {ev.benefits.store_hmv && <div><span className="text-slate-600">HMV特典:</span> {stringify(ev.benefits.store_hmv)}</div>}
                                                                                {ev.benefits.store_animate && <div><span className="text-slate-600">アニメイト特典:</span> {stringify(ev.benefits.store_animate)}</div>}
                                                                                {ev.benefits.store_amazon && <div><span className="text-slate-500">Amazon特典:</span> {stringify(ev.benefits.store_amazon)}</div>}
                                                                                {ev.benefits.lottery && <div><span className="text-slate-600">応募抽選:</span> {stringify(ev.benefits.lottery)}</div>}
                                                                            </div>
                                                                        ) : (
                                                                            <div className="text-sm text-slate-700">{stringify(ev.benefits)}</div>
                                                                        )}
                                                                    </div>
                                                                )}
                                                                
                                                                {/* URL・出典 */}
                                                                {(ev.url || ev.source) && (
                                                                    <div className="text-xs text-slate-500 pt-2 border-t border-slate-100">
                                                                        {ev.url && <a href={stringify(ev.url)} target="_blank" rel="noopener" className="text-blue-600 hover:underline break-all">{stringify(ev.url)}</a>}
                                                                        {ev.source && <span className="ml-2">（{stringify(ev.source)}）</span>}
                                                                    </div>
                                                                )}
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-sm text-slate-700">
                                                    <Text text={rel.release_events} />
                                                </div>
                                            )}
                                        </div>
                                    </Section>
                                )}

                                {/* CD流通情報（API取得） */}
                                {r.cdInfo && r.cdInfo.items && r.cdInfo.items.length > 0 && (
                                    <Section title={`CD流通情報（${r.cdInfo.count}件）`}>
                                        <details>
                                            <summary className="text-xs font-medium text-slate-600 cursor-pointer hover:text-slate-800 bg-slate-100 p-2 rounded">
                                                流通CD一覧を表示（{r.cdInfo.count}件）
                                            </summary>
                                            <div className="mt-2 text-xs text-slate-400 mb-2">出典: {r.cdInfo.source} / {r.cdInfo.fetchedAt}</div>
                                            <div className="overflow-x-auto">
                                                <table className="w-full text-xs border-collapse">
                                                    <thead>
                                                        <tr className="bg-slate-100">
                                                            <th className="text-left p-1 border">発売日</th>
                                                            <th className="text-left p-1 border">タイトル</th>
                                                            <th className="text-left p-1 border">形態</th>
                                                            <th className="text-right p-1 border">価格</th>
                                                            <th className="text-left p-1 border">品番</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {r.cdInfo.items.slice(0, 20).map((cd, idx) => (
                                                            <tr key={idx} className="hover:bg-slate-50">
                                                                <td className="p-1 border text-slate-600">{cd.release_date || '-'}</td>
                                                                <td className="p-1 border font-medium">{cd.title || '-'}</td>
                                                                <td className="p-1 border text-slate-500">{cd.promotion || cd.media || '-'}</td>
                                                                <td className="p-1 border text-right">{cd.price ? `¥${Number(cd.price).toLocaleString()}` : '-'}</td>
                                                                <td className="p-1 border text-slate-400">{cd.hinban || '-'}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                                {r.cdInfo.items.length > 20 && (
                                                    <div className="text-xs text-slate-400 mt-1">※ 最新20件を表示（全{r.cdInfo.count}件）</div>
                                                )}
                                            </div>
                                            <div className="mt-2 text-xs text-slate-500">
                                                ※ 非流通のインディーズ・自主制作CDはPerplexity検索結果を参照
                                            </div>
                                        </details>
                                    </Section>
                                )}

                                {/* グッズ・物販 - 重要情報として詳細表示 */}
                                <Section title="グッズ・物販">
                                    <div className="bg-slate-50 border border-slate-200 rounded-lg p-3">
                                        {/* 公式EC */}
                                        <div className="mb-3">
                                            <div className="text-xs font-bold text-slate-700 mb-1">公式通販</div>
                                            <div className="bg-white rounded p-2 text-sm">
                                                {g.ec_url && (
                                                    <div className="mb-1">
                                                        <a href={stringify(g.ec_url)} target="_blank" rel="noopener" className="text-blue-600 hover:underline font-medium">
                                                            {g.ec_name || '公式ショップ'}
                                                        </a>
                                                        {g.ec_type && <span className="ml-2 text-xs text-slate-500">（{stringify(g.ec_type)}）</span>}
                                                    </div>
                                                )}
                                                {!g.ec_url && <span className="text-slate-400">公式EC未確認</span>}
                                            </div>
                                        </div>
                                        
                                        {/* 写真系グッズ */}
                                        {g.photo_goods && typeof g.photo_goods === 'object' && Object.values(g.photo_goods).some(v => v) && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-700 mb-1">写真系グッズ</div>
                                                <div className="bg-white rounded p-2 text-xs grid grid-cols-2 gap-2">
                                                    {g.photo_goods.raw_photo && <div><span className="text-slate-500">生写真:</span> <span className="font-medium">{stringify(g.photo_goods.raw_photo)}</span></div>}
                                                    {g.photo_goods.bromide && <div><span className="text-slate-500">ブロマイド:</span> {stringify(g.photo_goods.bromide)}</div>}
                                                    {g.photo_goods.cheki && <div><span className="text-slate-500">チェキ:</span> {stringify(g.photo_goods.cheki)}</div>}
                                                    {g.photo_goods.postcard && <div><span className="text-slate-500">ポストカード:</span> {stringify(g.photo_goods.postcard)}</div>}
                                                    {g.photo_goods.photobook && <div><span className="text-slate-500">写真集:</span> {stringify(g.photo_goods.photobook)}</div>}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* アパレル */}
                                        {g.apparel && typeof g.apparel === 'object' && Object.values(g.apparel).some(v => v) && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-700 mb-1">アパレル</div>
                                                <div className="bg-white rounded p-2 text-xs grid grid-cols-2 gap-2">
                                                    {g.apparel.tshirt && <div><span className="text-slate-500">Tシャツ:</span> {stringify(g.apparel.tshirt)}</div>}
                                                    {g.apparel.hoodie && <div><span className="text-slate-500">パーカー:</span> {stringify(g.apparel.hoodie)}</div>}
                                                    {g.apparel.towel && <div><span className="text-slate-500">タオル:</span> {stringify(g.apparel.towel)}</div>}
                                                    {g.apparel.happi && <div><span className="text-slate-500">法被:</span> {stringify(g.apparel.happi)}</div>}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* 応援グッズ */}
                                        {g.support_goods && typeof g.support_goods === 'object' && Object.values(g.support_goods).some(v => v) && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-700 mb-1">応援グッズ</div>
                                                <div className="bg-white rounded p-2 text-xs grid grid-cols-2 gap-2">
                                                    {g.support_goods.penlight && <div><span className="text-slate-500">ペンライト:</span> <span className="font-medium">{stringify(g.support_goods.penlight)}</span></div>}
                                                    {g.support_goods.uchiwa && <div><span className="text-slate-500">うちわ:</span> {stringify(g.support_goods.uchiwa)}</div>}
                                                    {g.support_goods.fan_towel && <div><span className="text-slate-500">推しタオル:</span> {stringify(g.support_goods.fan_towel)}</div>}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* アクセサリー */}
                                        {g.accessories && typeof g.accessories === 'object' && Object.values(g.accessories).some(v => v) && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-700 mb-1">アクセサリー・小物</div>
                                                <div className="bg-white rounded p-2 text-xs grid grid-cols-2 gap-2">
                                                    {g.accessories.acrylic_stand && <div><span className="text-slate-500">アクスタ:</span> {stringify(g.accessories.acrylic_stand)}</div>}
                                                    {g.accessories.acrylic_keychain && <div><span className="text-slate-500">アクキー:</span> {stringify(g.accessories.acrylic_keychain)}</div>}
                                                    {g.accessories.can_badge && <div><span className="text-slate-500">缶バッジ:</span> {stringify(g.accessories.can_badge)}</div>}
                                                    {g.accessories.rubber_band && <div><span className="text-slate-500">ラバーバンド:</span> {stringify(g.accessories.rubber_band)}</div>}
                                                    {g.accessories.strap && <div><span className="text-slate-500">ストラップ:</span> {stringify(g.accessories.strap)}</div>}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ランダム商品情報 */}
                                        {g.random_goods && typeof g.random_goods === 'object' && g.random_goods.exists && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-600 mb-1">ランダム商品</div>
                                                <div className="bg-slate-50 rounded p-2 text-xs border border-slate-200">
                                                    <div className="font-medium text-slate-600">ランダム商品あり</div>
                                                    {g.random_goods.complete_cost && (
                                                        <div className="text-slate-600">全種コンプ目安: {stringify(g.random_goods.complete_cost)}</div>
                                                    )}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* ライブ会場物販 */}
                                        {g.live_goods && typeof g.live_goods === 'object' && (g.live_goods.venue_limited || g.live_goods.online_available) && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-700 mb-1">ライブ会場物販</div>
                                                <div className="bg-white rounded p-2 text-xs">
                                                    {g.live_goods.venue_limited && <div><span className="text-slate-500">会場限定:</span> {stringify(g.live_goods.venue_limited)}</div>}
                                                    {g.live_goods.online_available && <div><span className="text-slate-500">通販対応:</span> {stringify(g.live_goods.online_available)}</div>}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* 価格帯 */}
                                        {g.price_range && typeof g.price_range === 'object' && Object.values(g.price_range).some(v => v) && (
                                            <div className="mb-3">
                                                <div className="text-xs font-bold text-slate-700 mb-1">価格帯</div>
                                                <div className="bg-white rounded p-2 text-xs">
                                                    {g.price_range.low && <div><span className="text-slate-500">〜1000円:</span> {stringify(g.price_range.low)}</div>}
                                                    {g.price_range.mid && <div><span className="text-slate-500">1000〜3000円:</span> {stringify(g.price_range.mid)}</div>}
                                                    {g.price_range.high && <div><span className="text-slate-500">3000円〜:</span> {stringify(g.price_range.high)}</div>}
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* 旧形式のlineupがある場合 */}
                                        {g.lineup && !g.photo_goods && (
                                            <div>
                                                <div className="text-xs font-bold text-slate-700 mb-1">ラインナップ</div>
                                                <div className="bg-white rounded p-2 text-sm">
                                                    <Text text={g.lineup} />
                                                </div>
                                            </div>
                                        )}
                                        
                                        {/* 仕入先 */}
                                        {g.supplier && (
                                            <div className="mt-2 text-xs text-slate-500">
                                                仕入先: {stringify(g.supplier)}
                                            </div>
                                        )}
                                    </div>
                                </Section>

                                <Section title="ファンクラブ">
                                    <Row label="FC有無" value={fc.exists === true || fc.exists === 'true' || fc.has_fc === true ? '有' : (fc.exists === false || fc.exists === 'false' ? '無' : '不明')} />
                                    <Row label="FC名" value={fc.name} />
                                    <Row label="FC URL" value={fc.url} url={stringify(fc.url)} />
                                    <Row label="料金" value={fc.price} />
                                    <Row label="FC内EC" value={fc.has_ec === true || fc.has_ec === 'true' ? '有' : (fc.has_ec === false || fc.has_ec === 'false' ? '無' : '不明')} />
                                    {fc.benefits && <Text text={fc.benefits} />}
                                </Section>

                                <Section title="ファン層">
                                    <Row label="性別比" value={f.gender} />
                                    <Row label="年齢層" value={f.age} />
                                    <Row label="地域" value={f.region} />
                                    <Row label="呼称" value={f.nickname} />
                                    {f.characteristics && <div className="mt-2 p-2 bg-slate-50 rounded text-sm"><Text text={f.characteristics} /></div>}
                                    {f.inference_basis && (
                                        <div className="mt-2 p-2 bg-slate-50 rounded text-xs text-slate-600">
                                            <span className="font-medium">推測根拠:</span> {stringify(f.inference_basis)}
                                        </div>
                                    )}
                                    {/* ファン層データがない場合の注意 */}
                                    {!f.gender && !f.age && !f.region && (
                                        <div className="text-xs text-slate-600 mt-2 p-2 bg-slate-50 rounded">
                                            ファン層情報が取得できませんでした。<br/>
                                            追加調査で「ファン層」ボタンをクリックして詳細分析してください。
                                        </div>
                                    )}
                                </Section>

                                <Section title={`オンラインイベント（${YEAR_RANGE_SHORT}）`}>
                                    <Row label="実施" value={o.exists === true || o.exists === 'true' || o.has_online_meet === true ? '有' : (o.exists === false || o.exists === 'false' ? '無' : '不明')} />
                                    <Row label="プラットフォーム" value={o.platform} />
                                    <Row label="頻度" value={o.frequency} />
                                    {o.limista && (
                                        <div className="py-1 px-2 my-1 rounded text-sm">
                                            <span className="text-slate-500">limista.com: </span>
                                            {(o.limista === 'あり' || o.limista === '経験あり' || o.limista?.includes('あり') || o.limista?.includes('利用経験あり')) ? (
                                                <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded font-medium">利用経験あり</span>
                                            ) : (o.limista === 'なし' || o.limista === '経験なし' || o.limista?.includes('なし')) ? (
                                                <span className="bg-slate-100 text-slate-600 px-2 py-0.5 rounded">利用経験なし</span>
                                            ) : (
                                                <span className="text-slate-500">{stringify(o.limista)}</span>
                                            )}
                                        </div>
                                    )}
                                    {o.limista_history && (
                                        <div className="mt-2 p-2 bg-slate-50 rounded text-sm">
                                            <span className="font-medium text-slate-600">limista履歴:</span>
                                            <Text text={o.limista_history} />
                                        </div>
                                    )}
                                    {o.details && <Text text={o.details} />}
                                </Section>

                                {/* 最新ニュース */}
                                {(news.recent || news.upcoming || news.sns_topics) && (
                                    <Section title="最新ニュース・話題">
                                        {news.recent && (
                                            <div className="mb-2">
                                                <span className="text-xs font-medium text-slate-500">直近のニュース:</span>
                                                <Text text={news.recent} />
                                            </div>
                                        )}
                                        {news.upcoming && (
                                            <div className="mb-2">
                                                <span className="text-xs font-medium text-slate-500">今後の予定:</span>
                                                <Text text={news.upcoming} />
                                            </div>
                                        )}
                                        {news.sns_topics && (
                                            <div>
                                                <span className="text-xs font-medium text-slate-500">SNSの話題:</span>
                                                <Text text={news.sns_topics} />
                                            </div>
                                        )}
                                    </Section>
                                )}

                                <Section title="コンタクト">
                                    <Row label="公式サイト" value={c.official} url={stringify(c.official)} />
                                    <Row label="問い合わせ" value={c.inquiry} url={stringify(c.inquiry)} />
                                    <Row label="メール" value={c.email} />
                                    {c.other && <Text text={c.other} />}
                                </Section>

                                <Section title="リンク">
                                    <div className="flex flex-wrap">
                                        <Link url={c.official} label="公式" />
                                        <Link url={s.twitter?.url} label="Twitter" />
                                        <Link url={s.youtube?.url} label="YouTube" />
                                        <Link url={s.instagram?.url} label="Instagram" />
                                        <Link url={s.tiktok?.url} label="TikTok" />
                                        <Link url={g.ec_url} label="EC" />
                                        <Link url={fc.url} label="FC" />
                                        <Link url={c.inquiry} label="問い合わせ" />
                                    </div>
                                </Section>
                            </>
                        )}

                        {/* 追加調査セクション */}
                        <div className="pt-2 border-t">
                            <button 
                                onClick={() => setShowAdditional(!showAdditional)}
                                className="text-sm text-slate-600 hover:text-slate-800 font-medium"
                            >
                                {showAdditional ? '▼ 追加調査を閉じる' : '▶ 追加調査を行う'}
                            </button>
                            
                            {showAdditional && (
                                <div className="mt-3 p-3 bg-slate-50 rounded border border-slate-200">
                                    <div className="mb-2">
                                        <label className="text-xs text-slate-600 block mb-1">
                                            追加で調べたい内容を入力（{'{name}'}でタレント名、{'{agency}'}で事務所名に置換）
                                        </label>
                                        <textarea
                                            value={additionalPrompt}
                                            onChange={(e) => setAdditionalPrompt(e.target.value)}
                                            placeholder={`例: {name}の過去のテレビ出演歴を詳しく調べてください`}
                                            className="w-full p-2 border rounded text-sm"
                                            rows="3"
                                        />
                                    </div>
                                    <div className="flex gap-2 mb-3">
                                        <button
                                            onClick={runAdditionalSearch}
                                            disabled={searching || !additionalPrompt.trim()}
                                            className="px-3 py-1 bg-slate-700 text-white rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed"
                                        >
                                            {searching ? '検索中...' : '検索'}
                                        </button>
                                        <button
                                            onClick={() => setAdditionalPrompt(`{name}のリリースイベント（リリイベ）情報を徹底的に調べてください。

■ 検索してください：
- "{name} リリースイベント"
- "{name} 握手会 サイン会"
- "site:tower.jp {name}"
- "site:hmv.co.jp {name}"
- "{name} 購入特典"

■ 各イベントについて必ず記載：
1. 日時・会場
2. イベント内容（握手会、サイン会、チェキ会等）
3. 参加条件（CD何枚購入で1回、先着/抽選、時間制限等）
4. 特典内容を詳しく（ブロマイド、生写真、ポストカード、店舗特典等）
5. イベント詳細ページのURL（tower.jp、hmv.co.jp、公式サイト等の完全なURL）

特典とURLは必ず記載してください。`)}
                                            className="px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300"
                                        >
                                            リリイベ詳細
                                        </button>
                                        <button
                                            onClick={() => setAdditionalPrompt(`{name}のlimista.comでの過去のイベント開催履歴を調べてください`)}
                                            className="px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300"
                                        >
                                            limista履歴
                                        </button>
                                        <button
                                            onClick={() => setAdditionalPrompt(`{name}のファン層・客層を徹底的に分析してください。

■ 以下のすべてで検索してください：
- "{name} ファン層"
- "{name} ライブ 客層"
- "{name} 現場 レポ"
- "{name} 握手会 レポ"
- "{name} イベント 感想"
- "{name} ファン 特徴"

■ 以下の情報源から推測してください：
1. ライブレポート・イベントレポートの客層描写
2. SNS（Twitter/X）でのファンの年齢層・性別の傾向
3. 販売グッズの傾向（男性向け/女性向け）
4. アーティスト本人の発言やインタビュー

■ 回答形式（必ず埋めてください）：
- 性別比: ○○（例：男性7割・女性3割、ほぼ女性）
- 年齢層: ○○（例：20代後半〜30代がメイン）
- 地域: ○○（例：首都圏中心）
- ファンの呼称: ○○
- 特徴: ○○
- 推測根拠: ○○（どの情報から判断したか）`)}
                                            className="px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300"
                                        >
                                            ファン層
                                        </button>
                                        <button
                                            onClick={() => setAdditionalPrompt(`{name}の最新のニュースや話題を調べてください`)}
                                            className="px-2 py-1 bg-slate-200 rounded text-xs hover:bg-slate-300"
                                        >
                                            最新ニュース
                                        </button>
                                    </div>
                                    
                                    {/* 追加調査結果 */}
                                    {additionalResult.length > 0 && (
                                        <div className="space-y-2">
                                            <div className="text-xs font-medium text-slate-600">調査結果:</div>
                                            {additionalResult.map((ar, idx) => (
                                                <details key={idx} className="bg-white rounded border p-2" open={idx === additionalResult.length - 1}>
                                                    <summary className="text-xs font-medium cursor-pointer text-slate-600">
                                                        {ar.prompt.substring(0, 50)}... ({ar.time})
                                                    </summary>
                                                    <pre className="mt-2 text-xs whitespace-pre-wrap text-slate-700 max-h-60 overflow-y-auto">{ar.result}</pre>
                                                </details>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        {/* デバッグ: 検索結果 */}
                        <details className="pt-2 border-t">
                            <summary className="text-xs text-slate-400 cursor-pointer">検索結果を表示（デバッグ）</summary>
                            <div className="mt-2 space-y-2">
                                {Object.entries(raw).map(([k, v]) => (
                                    <details key={k} className="bg-slate-50 rounded p-2">
                                        <summary className="text-xs font-medium cursor-pointer">{k}</summary>
                                        <pre className="text-xs whitespace-pre-wrap mt-1 max-h-40 overflow-y-auto">{v}</pre>
                                    </details>
                                ))}
                            </div>
                        </details>
                        
                        {/* デバッグ: パース結果 */}
                        <details className="pt-2 border-t">
                            <summary className="text-xs text-slate-400 cursor-pointer">🔧 パース結果を表示（デバッグ）</summary>
                            <pre className="mt-2 text-xs bg-slate-100 p-2 rounded whitespace-pre-wrap max-h-60 overflow-y-auto">
                                {JSON.stringify({ basic: b, sns: s, live: l, release: rel, goods: g, fanclub: fc, fans: f, online: o, contact: c }, null, 2)}
                            </pre>
                        </details>
                    </div>
                </div>
            );
        };

        // ====== Main App ======
        const App = () => {
            const [mode, setMode] = useState('web');
            const [searchMode, setSearchMode] = useState('quick'); // 'quick' or 'full'
            const [agencyName, setAgencyName] = useState('');
            const [rawText, setRawText] = useState('');
            const [phase, setPhase] = useState('input');
            const [roster, setRoster] = useState(null);
            const [selected, setSelected] = useState(new Set());
            const [results, setResults] = useState({});
            const [loading, setLoading] = useState('');
            const [error, setError] = useState(null);
            const [progress, setProgress] = useState({ c: 0, t: 0, s: '' });
            const [usage, setUsage] = useState({ 
                perplexity: { requests: 0, prompt_tokens: 0, completion_tokens: 0 },
                gemini: { requests: 0, prompt_tokens: 0, completion_tokens: 0 },
                openai: { requests: 0, prompt_tokens: 0, completion_tokens: 0 }
            });
            const [paused, setPaused] = useState(false);
            const pauseRef = useRef(false);
            const abortRef = useRef(false);
            
            // 履歴関連のstate
            const [historyList, setHistoryList] = useState([]);
            const [historySearch, setHistorySearch] = useState('');
            const [historyAgency, setHistoryAgency] = useState('');
            const [historyAgencies, setHistoryAgencies] = useState([]);
            const [historySelected, setHistorySelected] = useState(new Set());
            const [historyLoading, setHistoryLoading] = useState(false);
            const [historyDeleting, setHistoryDeleting] = useState(false);
            
            // 履歴削除
            const deleteHistory = async () => {
                if (historySelected.size === 0) return;
                if (!confirm(`選択した${historySelected.size}件の履歴を削除しますか？`)) return;
                
                setHistoryDeleting(true);
                try {
                    const items = historyList
                        .filter(h => historySelected.has(h.talentName + '|' + h.agencyName))
                        .map(h => ({ talentName: h.talentName, agencyName: h.agencyName }));
                    
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target: 'cache_delete_bulk', payload: { items } })
                    });
                    const result = await res.json();
                    
                    if (result.success) {
                        alert(`${result.deleted}件を削除しました`);
                        setHistorySelected(new Set());
                        loadHistory(); // 再読み込み
                    }
                } catch (e) {
                    console.error('Delete failed:', e);
                    alert('削除に失敗しました');
                }
                setHistoryDeleting(false);
            };
            
            // 詳細（結果画面から追加検索）
            const handleDetailSearch = async (talentIds) => {
                if (!talentIds || talentIds.length === 0) return;
                
                setPhase('analyzing');
                const targets = roster.talents.filter(t => talentIds.includes(t.id));
                setProgress({ c: 0, t: targets.length, s: '詳細中...' });
                
                for (let i = 0; i < targets.length; i++) {
                    if (abortRef.current) break;
                    
                    const t = targets[i];
                    const name = t.name;
                    const agency = roster.agency_name || '';
                    const existing = results[t.id] || {};
                    const raw = existing._raw || {};
                    let searchCount = 0;
                    
                    try {
                        // バッチ2: 活動情報 + 特典会詳細
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: 活動・特典会検索中...` });
                        
                        const batch2Promises = [];
                        if (!raw.activity) {
                            batch2Promises.push(retry(() => searchPerplexity(PROMPT_ACTIVITY.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.activity = r; searchCount++; }));
                        }
                        if (!raw.tokuten) {
                            batch2Promises.push(retry(() => searchPerplexity(PROMPT_TOKUTEN.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.tokuten = r; searchCount++; }));
                        }
                        if (batch2Promises.length > 0) {
                            await Promise.all(batch2Promises);
                            await delay(300);
                        }
                        
                        // バッチ3: グッズ詳細
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: グッズ情報検索中...` });
                        if (!raw.goods_detail) {
                            raw.goods_detail = await retry(() => searchPerplexity(PROMPT_GOODS_DETAIL.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency)));
                            searchCount++;
                            await delay(300);
                        }
                        
                        // バッチ4: ファンサービス、連絡先、ニュース
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: 補助情報検索中...` });
                        const batch4Promises = [];
                        if (!raw.fanservice) {
                            batch4Promises.push(retry(() => searchPerplexityLight(PROMPT_FANSERVICE.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.fanservice = r; searchCount++; }));
                        }
                        if (!raw.contact) {
                            batch4Promises.push(retry(() => searchPerplexityLight(PROMPT_CONTACT.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.contact = r; searchCount++; }));
                        }
                        if (!raw.news_all) {
                            batch4Promises.push(retry(() => searchPerplexityLight(PROMPT_NEWS_ALL.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.news_all = r; searchCount++; }));
                        }
                        if (batch4Promises.length > 0) {
                            await Promise.all(batch4Promises);
                            await delay(200);
                        }
                        
                        // キャッシュに保存
                        const dataToCache = {};
                        if (raw.activity) dataToCache.activity = raw.activity;
                        if (raw.tokuten) dataToCache.tokuten = raw.tokuten;
                        if (raw.goods_detail) dataToCache.goods_detail = raw.goods_detail;
                        if (raw.fanservice) dataToCache.fanservice = raw.fanservice;
                        if (raw.contact) dataToCache.contact = raw.contact;
                        if (raw.news_all) dataToCache.news_all = raw.news_all;
                        if (Object.keys(dataToCache).length > 0) {
                            cacheSave(name, agency, dataToCache);
                        }
                        
                        // 再パース
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: データ整形中...` });
                        const all = Object.entries(raw).map(([k, v]) => {
                            if (!v) return '';
                            const truncated = v.length > 4000 ? v.substring(0, 4000) + '...(省略)' : v;
                            return `【${k}】\n${truncated}`;
                        }).filter(s => s).join('\n\n');
                        
                        let parsed = {};
                        try {
                            parsed = await retry(() => parseOpenAI(PROMPT_PARSE.replace('{search_results}', all)));
                        } catch (e) {
                            console.warn('Parse error', e);
                            // パース失敗時は既存データを維持
                            parsed = { ...existing };
                        }
                        
                        parsed._raw = raw;
                        parsed._rawAll = all;
                        parsed._fetchedAt = new Date().toLocaleString('ja-JP');
                        parsed._searchCount = (existing._searchCount || 0) + searchCount;
                        parsed._detailSearched = true;
                        
                        setResults(p => ({ ...p, [t.id]: parsed }));
                        if (i < targets.length - 1) await delay(500);
                        
                    } catch (e) {
                        console.error(e);
                    }
                }
                setPhase('done');
            };

            updateUsage = (target, u) => setUsage(prev => ({
                ...prev,
                [target]: {
                    requests: prev[target].requests + 1,
                    prompt_tokens: prev[target].prompt_tokens + (u.prompt_tokens || 0),
                    completion_tokens: prev[target].completion_tokens + (u.completion_tokens || 0)
                }
            }));
            
            // 履歴一覧を取得
            const loadHistory = async () => {
                setHistoryLoading(true);
                try {
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            target: 'cache_list', 
                            payload: { search: historySearch, agency: historyAgency, limit: 200 } 
                        })
                    });
                    const data = await res.json();
                    setHistoryList(data.list || []);
                    setHistoryAgencies(data.agencies || []);
                } catch (e) {
                    console.error('History load failed:', e);
                }
                setHistoryLoading(false);
            };
            
            // 履歴モードに切り替え時に読み込み
            useEffect(() => {
                if (mode === 'history') {
                    loadHistory();
                }
            }, [mode, historySearch, historyAgency]);
            
            // 履歴からキャッシュデータを読み込んで結果表示
            const loadFromHistory = async () => {
                if (historySelected.size === 0) return;
                
                setPhase('analyzing');
                setProgress({ c: 0, t: historySelected.size, s: 'キャッシュから読み込み中...' });
                
                const selectedItems = historyList.filter(h => historySelected.has(h.talentName + '|' + h.agencyName));
                const talents = selectedItems.map((h, i) => ({ id: `H${i}`, name: h.talentName, type: 'UNKNOWN' }));
                
                // 仮のrosterを作成
                const agency = selectedItems[0]?.agencyName || '履歴から読み込み';
                setRoster({ agency_name: agency, talents });
                setSelected(new Set(talents.map(t => t.id)));
                
                for (let i = 0; i < selectedItems.length; i++) {
                    const item = selectedItems[i];
                    setProgress({ c: i + 1, t: selectedItems.length, s: `${item.talentName}: 読み込み中...` });
                    
                    try {
                        const res = await fetch(PROXY_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                target: 'cache_get_full', 
                                payload: { talentName: item.talentName, agencyName: item.agencyName } 
                            })
                        });
                        const cacheData = await res.json();
                        
                        if (cacheData.found && cacheData.data) {
                            // キャッシュデータを結果形式に変換
                            const parsed = {
                                basic: cacheData.data.basic || { name: item.talentName },
                                sns: cacheData.data.sns || {},
                                live: cacheData.data.live || {},
                                release: cacheData.data.release || {},
                                goods: cacheData.data.goods || {},
                                fanclub: cacheData.data.fanclub || {},
                                fans: cacheData.data.fans || {},
                                online: cacheData.data.online || {},
                                news: cacheData.data.news || {},
                                contact: cacheData.data.contact || {},
                                _raw: {
                                    profile: cacheData.data.profile || '',
                                    sns: cacheData.data.sns_raw || '',
                                    live: cacheData.data.live || '',
                                    release: cacheData.data.release || ''
                                },
                                _fetchedAt: cacheData.data._updatedAt ? new Date(cacheData.data._updatedAt * 1000).toLocaleString('ja-JP') : '',
                                _cacheHits: 10, // 全てキャッシュ
                                _searchCount: 0,
                                _fromCache: true
                            };
                            setResults(p => ({ ...p, [talents[i].id]: parsed }));
                        }
                    } catch (e) {
                        console.error('Cache load failed:', item.talentName, e);
                        setResults(p => ({ ...p, [talents[i].id]: { error: true, name: item.talentName, message: e.message } }));
                    }
                }
                
                setPhase('done');
            };

            const delay = (ms) => new Promise(r => setTimeout(r, ms));
            const retry = async (fn, n = 2) => {
                for (let i = 0; i < n; i++) {
                    try { return await fn(); }
                    catch (e) { 
                        console.warn(`Retry ${i+1}/${n}:`, e.message);
                        if (i === n - 1) throw e; 
                        await delay(1000 * (i + 1)); 
                    }
                }
            };

            const handleExtract = async () => {
                setPhase('extracting');
                setError(null);
                try {
                    let res;
                    if (mode === 'web') {
                        setLoading("検索中...");
                        res = await retry(() => searchPerplexityJson(PROMPT_ROSTER.replace('{agency_name}', agencyName)));
                    } else {
                        setLoading("解析中...");
                        res = await retry(() => parseOpenAI(`テキストからタレント名を抽出しJSON出力: { "agency_name": "事務所", "talents": [{ "id": "T001", "name": "名前", "type": "SOLO/GROUP" }] }\nテキスト: ${rawText.substring(0, 30000)}`));
                    }
                    if (!res.talents?.length) throw new Error("見つかりませんでした");
                    setRoster(res);
                    setSelected(new Set(res.talents.map(t => t.id)));
                    setPhase('review');
                } catch (e) {
                    setError(e.message);
                    setPhase('input');
                }
            };

            // キャッシュAPI
            const cacheGet = async (talentName, agencyName) => {
                try {
                    const res = await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target: 'cache_get', payload: { talentName, agencyName } })
                    });
                    return await res.json();
                } catch (e) {
                    console.warn('Cache get failed:', e);
                    return { found: false };
                }
            };
            
            const cacheSave = async (talentName, agencyName, data) => {
                try {
                    await fetch(PROXY_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ target: 'cache_save', payload: { talentName, agencyName, data } })
                    });
                } catch (e) {
                    console.warn('Cache save failed:', e);
                }
            };

            const handleAnalyze = async (mode = searchMode) => {
                const isQuick = mode === 'quick';
                setPhase('analyzing');
                setPaused(false);
                pauseRef.current = false;
                abortRef.current = false;
                const targets = roster.talents.filter(t => selected.has(t.id));
                setProgress({ c: 0, t: targets.length, s: isQuick ? 'クイック中...' : '詳細中...' });

                for (let i = 0; i < targets.length; i++) {
                    while (pauseRef.current && !abortRef.current) await delay(500);
                    if (abortRef.current) break;

                    const t = targets[i];
                    const name = t.name;
                    const agency = roster.agency_name || '';
                    const raw = {};
                    let cacheHits = 0;
                    let searchCount = 0;

                    try {
                        // キャッシュをチェック
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: キャッシュ確認中...` });
                        const cacheResult = await cacheGet(name, agency);
                        const cache = cacheResult.found ? cacheResult.cache : null;
                        const validKeys = cacheResult.validKeys || [];
                        
                        console.log(`[${name}] Cache:`, cacheResult.found ? `${validKeys.length}件有効` : 'なし');

                        // === コスト最適化版: 10検索→6検索 ===
                        // Batch 1: profile, sns (sonar-pro × 2)
                        // Batch 2: activity (sonar-pro × 1) ← live + release 統合
                        // Batch 3: fanservice, contact, news_all (sonar × 3)
                        // コスト: 3×$0.005 + 3×$0.001 = $0.018/タレント (57%削減)
                        
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: 基本情報検索中...` });
                        
                        const batch1Promises = [];
                        
                        // キャッシュ有効なら使用、なければ検索
                        if (validKeys.includes('profile')) {
                            raw.profile = cache.profile;
                            cacheHits++;
                        } else {
                            batch1Promises.push(retry(() => searchPerplexity(PROMPT_PROFILE.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.profile = r; searchCount++; }));
                        }
                        
                        if (validKeys.includes('sns')) {
                            raw.sns = cache.sns;
                            cacheHits++;
                        } else {
                            batch1Promises.push(retry(() => searchSNS(PROMPT_SNS.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.sns = r; searchCount++; }));
                        }
                        
                        if (batch1Promises.length > 0) {
                            await Promise.all(batch1Promises);
                            await delay(300);
                        }

                        // === クイックの場合はここで終了 ===
                        if (isQuick) {
                            // 最低限のデータでパース
                            raw.activity = '';
                            raw.tokuten = '';
                            raw.goods_detail = '';
                            raw.fanservice = '';
                            raw.contact = '';
                            raw.news_all = '';
                        } else {
                        // === 詳細（フルモード）===
                        
                        // 中断チェック
                        if (abortRef.current) break;

                        // バッチ2: 活動情報 + 特典会詳細（重要なのでsonar-pro）
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: 活動・特典会検索中... (キャッシュ${cacheHits}件)` });
                        
                        const batch2Promises = [];
                        
                        // activity は live + release を統合（キャッシュキーは activity）
                        if (validKeys.includes('activity')) {
                            raw.activity = cache.activity;
                            cacheHits++;
                        } else if (validKeys.includes('live') && validKeys.includes('release')) {
                            // 旧形式のキャッシュがある場合は結合
                            raw.activity = `【ライブ情報】\n${cache.live}\n\n【リリース情報】\n${cache.release}`;
                            cacheHits += 2;
                        } else {
                            batch2Promises.push(retry(() => searchPerplexity(PROMPT_ACTIVITY.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.activity = r; searchCount++; }));
                        }
                        
                        // 特典会専用検索（重要情報）
                        if (validKeys.includes('tokuten')) {
                            raw.tokuten = cache.tokuten;
                            cacheHits++;
                        } else {
                            batch2Promises.push(retry(() => searchPerplexity(PROMPT_TOKUTEN.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.tokuten = r; searchCount++; }));
                        }
                        
                        if (batch2Promises.length > 0) {
                            await Promise.all(batch2Promises);
                            await delay(300);
                        }
                        
                        // 中断チェック
                        if (abortRef.current) break;
                        
                        // バッチ3: グッズ詳細（重要なのでsonar-pro）
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: グッズ情報検索中... (キャッシュ${cacheHits}件)` });
                        
                        const batch3Promises = [];
                        
                        // グッズ専用検索（重要情報）
                        if (validKeys.includes('goods_detail')) {
                            raw.goods_detail = cache.goods_detail;
                            cacheHits++;
                        } else {
                            batch3Promises.push(retry(() => searchPerplexity(PROMPT_GOODS_DETAIL.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.goods_detail = r; searchCount++; }));
                        }
                        
                        if (batch3Promises.length > 0) {
                            await Promise.all(batch3Promises);
                            await delay(300);
                        }

                        // 中断チェック
                        if (abortRef.current) break;

                        // バッチ4: ファンサービス、連絡先、ニュース（安いモデル）
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: 補助情報検索中... (キャッシュ${cacheHits}件)` });
                        
                        const batch4Promises = [];
                        
                        // fanservice は fanclub + online + ファン層を統合
                        if (validKeys.includes('fanservice')) {
                            raw.fanservice = cache.fanservice;
                            cacheHits++;
                        } else if (validKeys.includes('goods') && validKeys.includes('fanclub')) {
                            // 旧形式のキャッシュがある場合は結合
                            raw.fanservice = `【グッズ】\n${cache.goods}\n\n【ファンクラブ】\n${cache.fanclub}\n\n【オンライン】\n${cache.online || ''}`;
                            cacheHits += 3;
                        } else {
                            batch4Promises.push(retry(() => searchPerplexityLight(PROMPT_FANSERVICE.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.fanservice = r; searchCount++; }));
                        }
                        
                        if (validKeys.includes('contact')) {
                            raw.contact = cache.contact;
                            cacheHits++;
                        } else {
                            batch4Promises.push(retry(() => searchPerplexityLight(PROMPT_CONTACT.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.contact = r; searchCount++; }));
                        }
                        
                        // news_all は news + limista を統合
                        if (validKeys.includes('news_all')) {
                            raw.news_all = cache.news_all;
                            cacheHits++;
                        } else if (validKeys.includes('news') && validKeys.includes('limista')) {
                            raw.news_all = `【ニュース】\n${cache.news}\n\n【limista履歴】\n${cache.limista}`;
                            cacheHits += 2;
                        } else {
                            batch4Promises.push(retry(() => searchPerplexityLight(PROMPT_NEWS_ALL.replace(/{talent_name}/g, name).replace(/{agency_name}/g, agency))).then(r => { raw.news_all = r; searchCount++; }));
                        }
                        
                        if (batch4Promises.length > 0) {
                            try {
                                await Promise.all(batch4Promises);
                            } catch (e) {
                                console.warn('Batch 4 search failed:', e);
                            }
                            await delay(200);
                        }
                        
                        } // === 詳細ここまで ===
                        
                        // 旧キー名との互換性のためにマッピング
                        raw.live = raw.activity || '';
                        raw.release = raw.activity || '';
                        raw.goods = raw.goods_detail || raw.fanservice || '';
                        raw.fanclub = raw.fanservice || '';
                        raw.online = raw.fanservice || '';
                        raw.news = raw.news_all || '';
                        raw.limista = raw.news_all || '';
                        
                        // キャッシュに保存（新キー名で）
                        const dataToCache = {};
                        if (!validKeys.includes('profile') && raw.profile) dataToCache.profile = raw.profile;
                        if (!validKeys.includes('sns') && raw.sns) dataToCache.sns = raw.sns;
                        if (!validKeys.includes('activity') && raw.activity) dataToCache.activity = raw.activity;
                        if (!validKeys.includes('tokuten') && raw.tokuten) dataToCache.tokuten = raw.tokuten;
                        if (!validKeys.includes('goods_detail') && raw.goods_detail) dataToCache.goods_detail = raw.goods_detail;
                        if (!validKeys.includes('fanservice') && raw.fanservice) dataToCache.fanservice = raw.fanservice;
                        if (!validKeys.includes('contact') && raw.contact) dataToCache.contact = raw.contact;
                        if (!validKeys.includes('news_all') && raw.news_all) dataToCache.news_all = raw.news_all;
                        
                        if (Object.keys(dataToCache).length > 0) {
                            cacheSave(name, agency, dataToCache);
                        }
                        
                        console.log(`[${name}] 検索: ${searchCount}回, キャッシュ: ${cacheHits}件`);

                        setProgress({ c: i + 1, t: targets.length, s: `${name}: データ整形... (検索${searchCount}回/キャッシュ${cacheHits}件)` });
                        // 各検索結果を4000文字に制限（合計約32000文字）
                        const all = Object.entries(raw).map(([k, v]) => {
                            const truncated = v.length > 4000 ? v.substring(0, 4000) + '...(省略)' : v;
                            return `【${k}】\n${truncated}`;
                        }).join('\n\n');
                        let parsed = {};
                        try {
                            // クイック検索は軽量プロンプト、詳細検索はフルプロンプト
                            const parsePrompt = isQuick ? PROMPT_PARSE_QUICK : PROMPT_PARSE;
                            parsed = await retry(() => parseOpenAI(parsePrompt.replace('{search_results}', all)));
                            console.log('Parsed result:', parsed);
                        } catch (e) { 
                            console.warn('Parse error', e);
                            // パース失敗時は生データからシンプルに抽出
                            parsed = { _parseError: e.message };
                        }

                        // ファン層が空の場合、ジャンルから自動推測
                        if (!parsed.fans || (!parsed.fans.gender && !parsed.fans.age)) {
                            const genre = (parsed.basic?.genre || '').toLowerCase();
                            const type = parsed.basic?.type;
                            const memberCount = parseInt(parsed.basic?.member_count) || 0;
                            
                            let inferredFans = { inference_basis: 'ジャンル・活動形態から自動推測' };
                            
                            // ジャンルベースの推測
                            if (genre.includes('アイドル') || genre.includes('idol')) {
                                if (type === 'GROUP' && memberCount > 1) {
                                    // グループの性別を推測（メンバー名から判断するのは難しいので、一般的な傾向で）
                                    if (genre.includes('女性') || genre.includes('ガールズ') || genre.includes('girl')) {
                                        inferredFans = { gender: '男性8割・女性2割', age: '20代後半〜30代が中心', region: '首都圏中心', inference_basis: '女性アイドルグループのジャンルから推測' };
                                    } else if (genre.includes('男性') || genre.includes('ボーイズ') || genre.includes('boy')) {
                                        inferredFans = { gender: '女性9割・男性1割', age: '10代後半〜20代が中心', region: '首都圏中心', inference_basis: '男性アイドルグループのジャンルから推測' };
                                    } else {
                                        inferredFans = { gender: '男性7割・女性3割', age: '20代〜30代が中心', region: '首都圏中心', inference_basis: 'アイドルグループのジャンルから推測' };
                                    }
                                } else {
                                    inferredFans = { gender: '男性7割・女性3割', age: '20代〜30代が中心', inference_basis: 'アイドルのジャンルから推測' };
                                }
                            } else if (genre.includes('バンド') || genre.includes('ロック') || genre.includes('rock') || genre.includes('band')) {
                                inferredFans = { gender: '男女半々', age: '20代〜30代が中心', inference_basis: 'バンド・ロック系のジャンルから推測' };
                            } else if (genre.includes('声優') || genre.includes('アニソン')) {
                                inferredFans = { gender: '男性7割・女性3割', age: '20代後半〜30代が中心', inference_basis: '声優・アニソン系のジャンルから推測' };
                            } else if (genre.includes('vtuber') || genre.includes('バーチャル')) {
                                inferredFans = { gender: '男性8割・女性2割', age: '20代〜30代が中心', inference_basis: 'VTuberのジャンルから推測' };
                            } else if (genre.includes('k-pop') || genre.includes('韓国')) {
                                inferredFans = { gender: '女性8割・男性2割', age: '10代〜20代が中心', inference_basis: 'K-POP系のジャンルから推測' };
                            } else if (genre.includes('シンガーソングライター') || genre.includes('ssw')) {
                                inferredFans = { gender: '男女半々〜やや女性多め', age: '20代〜30代が中心', inference_basis: 'シンガーソングライターのジャンルから推測' };
                            } else if (genre.includes('ヒップホップ') || genre.includes('ラップ') || genre.includes('hip')) {
                                inferredFans = { gender: '男性6割・女性4割', age: '10代後半〜20代が中心', inference_basis: 'ヒップホップ系のジャンルから推測' };
                            }
                            
                            // 既存のfansオブジェクトとマージ
                            parsed.fans = { ...(parsed.fans || {}), ...inferredFans };
                            console.log('Inferred fans from genre:', parsed.fans);
                        }

                        // YouTube Data APIで正確な登録者数を取得
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: YouTube登録者数取得中...` });
                        let ytSuccess = false;
                        
                        // 方法1: パース結果のURLから取得
                        if (parsed.sns?.youtube?.url) {
                            try {
                                const ytStats = await getYouTubeStats(parsed.sns.youtube.url);
                                if (ytStats) {
                                    parsed.sns.youtube.subscribers = ytStats.subscriberCountFormatted;
                                    parsed.sns.youtube.subscriberCountRaw = ytStats.subscriberCount;
                                    parsed.sns.youtube.source = ytStats.source;
                                    parsed.sns.youtube.date = ytStats.fetchedAt;
                                    parsed.sns.youtube.channelTitle = ytStats.title;
                                    console.log('YouTube API result (from parsed URL):', ytStats);
                                    ytSuccess = true;
                                }
                            } catch (e) {
                                console.warn('YouTube API failed (parsed URL):', e);
                            }
                        }
                        
                        // 方法2: 生のSNS検索結果からURLを抽出
                        if (!ytSuccess && raw.sns) {
                            const ytUrlMatch = raw.sns.match(/https?:\/\/(www\.)?youtube\.com\/(channel\/[^\/\s\)]+|@[^\/\s\)]+|c\/[^\/\s\)]+|user\/[^\/\s\)]+)/i);
                            if (ytUrlMatch) {
                                try {
                                    const ytStats = await getYouTubeStats(ytUrlMatch[0]);
                                    if (ytStats) {
                                        if (!parsed.sns) parsed.sns = {};
                                        parsed.sns.youtube = {
                                            url: ytUrlMatch[0],
                                            subscribers: ytStats.subscriberCountFormatted,
                                            subscriberCountRaw: ytStats.subscriberCount,
                                            source: ytStats.source,
                                            date: ytStats.fetchedAt,
                                            channelTitle: ytStats.title
                                        };
                                        console.log('YouTube API result (from raw URL):', ytStats);
                                        ytSuccess = true;
                                    }
                                } catch (e) {
                                    console.warn('YouTube API failed (raw URL):', e);
                                }
                            }
                        }
                        
                        // 方法3: タレント名で直接検索（フォールバック）
                        if (!ytSuccess) {
                            try {
                                console.log('YouTube: Searching by talent name:', name);
                                const ytStats = await searchYouTubeByName(name);
                                if (ytStats) {
                                    if (!parsed.sns) parsed.sns = {};
                                    parsed.sns.youtube = {
                                        url: ytStats.url,
                                        subscribers: ytStats.subscriberCountFormatted,
                                        subscriberCountRaw: ytStats.subscriberCount,
                                        source: ytStats.source + ' (名前検索)',
                                        date: ytStats.fetchedAt,
                                        channelTitle: ytStats.title
                                    };
                                    console.log('YouTube API result (from name search):', ytStats);
                                }
                            } catch (e) {
                                console.warn('YouTube API failed (name search):', e);
                            }
                        }

                        // Twitter/X APIで正確なフォロワー数を取得
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: Twitterフォロワー数取得中...` });
                        let twSuccess = false;
                        
                        // 方法1: パース結果のURLから取得
                        if (parsed.sns?.twitter?.url) {
                            try {
                                const twStats = await getTwitterStats(parsed.sns.twitter.url);
                                if (twStats) {
                                    parsed.sns.twitter.followers = twStats.followersCountFormatted;
                                    parsed.sns.twitter.followersCountRaw = twStats.followersCount;
                                    parsed.sns.twitter.source = twStats.source;
                                    parsed.sns.twitter.date = twStats.fetchedAt;
                                    parsed.sns.twitter.name = twStats.name;
                                    parsed.sns.twitter.verified = twStats.verified;
                                    console.log('Twitter API result (from parsed URL):', twStats);
                                    twSuccess = true;
                                }
                            } catch (e) {
                                console.warn('Twitter API failed (parsed URL):', e);
                            }
                        }
                        
                        // 方法2: 生のSNS検索結果からURLを抽出
                        if (!twSuccess && raw.sns) {
                            const twUrlMatch = raw.sns.match(/https?:\/\/(www\.)?(twitter\.com|x\.com)\/(@?[a-zA-Z0-9_]+)/i);
                            if (twUrlMatch) {
                                try {
                                    const twStats = await getTwitterStats(twUrlMatch[0]);
                                    if (twStats) {
                                        if (!parsed.sns) parsed.sns = {};
                                        parsed.sns.twitter = {
                                            url: `https://x.com/${twStats.username}`,
                                            followers: twStats.followersCountFormatted,
                                            followersCountRaw: twStats.followersCount,
                                            source: twStats.source,
                                            date: twStats.fetchedAt,
                                            name: twStats.name,
                                            verified: twStats.verified
                                        };
                                        console.log('Twitter API result (from raw URL):', twStats);
                                        twSuccess = true;
                                    }
                                } catch (e) {
                                    console.warn('Twitter API failed (raw URL):', e);
                                }
                            }
                        }
                        
                        // 方法3: タレント名で直接検索（フォールバック）
                        if (!twSuccess) {
                            try {
                                console.log('Twitter: Searching by talent name:', name);
                                const twStats = await searchTwitterByName(name);
                                if (twStats) {
                                    if (!parsed.sns) parsed.sns = {};
                                    parsed.sns.twitter = {
                                        url: twStats.url,
                                        followers: twStats.followersCountFormatted,
                                        followersCountRaw: twStats.followersCount,
                                        source: twStats.source + ' (名前検索)',
                                        date: twStats.fetchedAt,
                                        name: twStats.name,
                                        verified: twStats.verified
                                    };
                                    console.log('Twitter API result (from name search):', twStats);
                                }
                            } catch (e) {
                                console.warn('Twitter API failed (name search):', e);
                            }
                        }

                        // CD流通情報を取得
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: CD流通情報取得中...` });
                        try {
                            const cdInfo = await searchCDInfo(name);
                            if (cdInfo && cdInfo.items.length > 0) {
                                parsed.cdInfo = cdInfo;
                                console.log('CD API result:', cdInfo);
                            }
                        } catch (e) {
                            console.warn('CD API failed:', e);
                        }

                        // Spotify情報を取得
                        setProgress({ c: i + 1, t: targets.length, s: `${name}: Spotify情報取得中...` });
                        try {
                            const spotifyInfo = await searchSpotify(name);
                            if (spotifyInfo) {
                                parsed.spotify = spotifyInfo;
                                console.log('Spotify API result:', spotifyInfo);
                            }
                        } catch (e) {
                            console.warn('Spotify API failed:', e);
                        }

                        parsed._raw = raw;
                        parsed._rawAll = all; // 全検索結果のテキストも保存
                        parsed._fetchedAt = new Date().toLocaleString('ja-JP'); // 取得日時
                        parsed._cacheHits = cacheHits; // キャッシュヒット数
                        parsed._searchCount = searchCount; // 実際の検索回数
                        setResults(p => ({ ...p, [t.id]: parsed }));
                        if (i < targets.length - 1) await delay(800);
                    } catch (e) {
                        console.error(e);
                        setResults(p => ({ ...p, [t.id]: { error: true, name, message: e.message, _raw: raw } }));
                        await delay(1000);
                    }
                }
                setPhase('done');
            };

            const toggle = () => { pauseRef.current = !pauseRef.current; setPaused(pauseRef.current); };
            const abort = () => { 
                abortRef.current = true; 
                pauseRef.current = false; 
                setPaused(false);
                // 即座にフェーズを変更（実行中の処理はバックグラウンドで完了）
                setPhase(Object.keys(results).length > 0 ? 'done' : 'review');
            };

            const downloadCSV = () => {
                const h = [
                    "アーティスト名",
                    "事務所名",
                    "直近のリリース",
                    "レコード会社",
                    "プロフィール経歴",
                    "Twitter",
                    "Twitterフォロワー",
                    "YouTube",
                    "YouTube登録者",
                    "Instagram",
                    "Instagramフォロワー",
                    "TikTok",
                    "TikTokフォロワー",
                    "Spotifyフォロワー",
                    "Spotify人気度",
                    "ファン層(性別)",
                    "ファン層(年齢)",
                    "ファン層(地域)",
                    "ファン層(推測根拠)",
                    "メンバー数",
                    "メンバー名",
                    "メンバー誕生日",
                    "直近3年ワンマン",
                    "直近3年リリース",
                    "去年リリイベ有無",
                    "去年リリイベ会場",
                    "リリイベレギュレーション",
                    "リリイベ特典",
                    "EC有無",
                    "EC URL",
                    "販売グッズ",
                    "FC有無",
                    "FC URL",
                    "オンラインイベント有無",
                    "リミスタ利用",
                    "limista履歴",
                    "最新ニュース",
                    "コンタクト"
                ];
                const rows = Array.from(selected).map(id => {
                    const r = results[id] || {};
                    const b = r.basic || {};
                    const s = r.sns || {};
                    const f = r.fans || {};
                    const l = r.live || {};
                    const rel = r.release || {};
                    const g = r.goods || {};
                    const fc = r.fanclub || {};
                    const o = r.online || {};
                    const c = r.contact || {};
                    const sp = r.spotify || {};
                    const news = r.news || {};
                    
                    // リリイベ情報を整理
                    const releaseEvents = rel.release_events;
                    let hasReleaseEvent = '不明';
                    let releaseEventVenues = '';
                    let releaseEventRegulation = '';
                    let releaseEventBenefits = '';
                    if (Array.isArray(releaseEvents) && releaseEvents.length > 0) {
                        hasReleaseEvent = 'あり';
                        releaseEventVenues = releaseEvents.map(e => e.venue).filter(v => v).join(' / ');
                        releaseEventRegulation = releaseEvents[0]?.regulation || '';
                        releaseEventBenefits = releaseEvents.map(e => e.benefits).filter(b => b).join(' / ');
                    } else if (releaseEvents && typeof releaseEvents === 'string') {
                        hasReleaseEvent = releaseEvents.includes('なし') ? 'なし' : 'あり';
                        releaseEventVenues = releaseEvents;
                    }
                    
                    // limista判定
                    const limistaExp = o.limista?.includes('あり') ? 'あり' : (o.limista?.includes('なし') ? 'なし' : '不明');
                    const limistaHistory = o.limista_history || '';
                    
                    // 最新ニュース
                    const recentNews = [news.recent, news.upcoming, news.sns_topics].filter(n => n).join(' / ');
                    
                    // EC有無判定
                    const hasEC = g.ec_url ? 'あり' : (g.ec_type ? 'あり' : '不明');
                    
                    // FC有無判定
                    const hasFC = (fc.exists === true || fc.exists === 'true' || fc.has_fc === true || fc.url) ? 'あり' : (fc.exists === false || fc.exists === 'false' ? 'なし' : '不明');
                    
                    // オンラインイベント有無判定
                    const hasOnline = (o.exists === true || o.exists === 'true' || o.has_online_meet === true || o.platform) ? 'あり' : (o.exists === false || o.exists === 'false' ? 'なし' : '不明');
                    
                    // メンバー情報（グループの場合）
                    let memberCount = b.member_count || '';
                    let memberNames = '';
                    let memberBirthdays = '';
                    
                    if (Array.isArray(b.members) && b.members.length > 0) {
                        // 配列の場合
                        if (!memberCount) memberCount = String(b.members.length);
                        memberNames = b.members.map(m => m.name).filter(n => n).join(' / ');
                        memberBirthdays = b.members.map(m => `${m.name || ''}:${m.birthday || '不明'}`).join(' / ');
                    } else if (b.members && typeof b.members === 'string') {
                        // 文字列の場合
                        const membersStr = b.members;
                        const match = membersStr.match(/(\d+)\s*人/);
                        if (match && !memberCount) {
                            memberCount = match[1];
                        } else if ((membersStr.includes('、') || membersStr.includes(',')) && !memberCount) {
                            memberCount = String(membersStr.split(/[、,]/).length);
                        }
                        memberNames = membersStr;
                    }
                    
                    return [
                        b.name || '', // アーティスト名
                        b.agency || '', // 事務所名
                        rel.cd || '', // 直近のリリース
                        b.label || '', // レコード会社
                        b.history || b.profile || '', // プロフィール経歴
                        s.twitter?.url || '', // Twitter
                        s.twitter?.followers || s.twitter?.followersCountRaw || '', // Twitterフォロワー
                        s.youtube?.url || '', // YouTube
                        s.youtube?.subscribers || s.youtube?.subscriberCountRaw || '', // YouTube登録者
                        s.instagram?.url || '', // Instagram
                        s.instagram?.followers || '', // Instagramフォロワー
                        s.tiktok?.url || '', // TikTok
                        s.tiktok?.followers || '', // TikTokフォロワー
                        sp.followers || '', // Spotifyフォロワー
                        sp.popularity || '', // Spotify人気度
                        f.gender || '', // ファン層(性別)
                        f.age || '', // ファン層(年齢)
                        f.region || '', // ファン層(地域)
                        f.inference_basis || '', // ファン層(推測根拠)
                        memberCount, // メンバー数
                        memberNames, // メンバー名
                        memberBirthdays, // メンバー誕生日
                        l.oneman || l.summary || '', // 直近3年ワンマン
                        rel.cd || '', // 直近3年リリース
                        hasReleaseEvent, // 去年リリイベ有無
                        releaseEventVenues, // 去年リリイベ会場
                        releaseEventRegulation, // リリイベレギュレーション
                        releaseEventBenefits, // リリイベ特典
                        hasEC, // EC有無
                        g.ec_url || '', // EC URL
                        g.lineup || '', // 販売グッズ
                        hasFC, // FC有無
                        fc.url || '', // FC URL
                        hasOnline, // オンラインイベント有無
                        limistaExp, // リミスタ利用
                        limistaHistory, // limista履歴
                        recentNews, // 最新ニュース
                        c.inquiry || c.official || '' // コンタクト
                    ].map(c => `"${String(c || '').replace(/"/g, '""').replace(/\n/g, ' ')}"`).join(",");
                });
                const blob = new Blob(["\uFEFF" + h.join(",") + "\n" + rows.join("\n")], { type: "text/csv" });
                const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${roster?.agency_name || 'export'}.csv`; a.click();
            };

            const total = usage.perplexity.requests + usage.gemini.requests + usage.openai.requests;
            
            // コスト計算（概算）
            const calcCost = (api) => {
                const u = usage[api];
                const rates = {
                    perplexity: { input: 3.0 / 1000000, output: 15.0 / 1000000 },
                    gemini: { input: 0.15 / 1000000, output: 0.60 / 1000000 },
                    openai: { input: 2.5 / 1000000, output: 10.0 / 1000000 }
                };
                const r = rates[api];
                return (u.prompt_tokens * r.input) + (u.completion_tokens * r.output);
            };
            const totalCost = calcCost('perplexity') + calcCost('gemini') + calcCost('openai');
            
            // 使用量パネル
            const UsagePanel = () => {
                if (total === 0) return null;
                const apis = [
                    { key: 'perplexity', name: 'Perplexity', bgClass: 'bg-slate-50', borderClass: 'border-slate-200', textClass: 'text-slate-600' },
                    { key: 'gemini', name: 'Gemini', bgClass: 'bg-slate-50', borderClass: 'border-slate-200', textClass: 'text-slate-600' },
                    { key: 'openai', name: 'OpenAI', bgClass: 'bg-slate-50', borderClass: 'border-slate-200', textClass: 'text-slate-600' }
                ];
                return (
                    <div className="bg-white rounded-lg border p-4 mb-4">
                        <div className="text-xs font-bold text-slate-500 uppercase mb-3">API使用量</div>
                        <div className="grid grid-cols-3 gap-3">
                            {apis.map(api => {
                                const u = usage[api.key];
                                const cost = calcCost(api.key);
                                if (u.requests === 0) return (
                                    <div key={api.key} className="bg-slate-50 rounded-lg p-3 opacity-50">
                                        <div className="text-xs text-slate-400 mb-1">{api.name}</div>
                                        <div className="text-slate-300 text-sm">未使用</div>
                                    </div>
                                );
                                return (
                                    <div key={api.key} className={`${api.bgClass} rounded-lg p-3 border ${api.borderClass}`}>
                                        <div className={`text-xs ${api.textClass} font-medium mb-1`}>{api.name}</div>
                                        <div className="space-y-1">
                                            <div className="flex justify-between text-xs">
                                                <span className="text-slate-500">リクエスト</span>
                                                <span className={`font-bold ${api.textClass}`}>{u.requests}回</span>
                                            </div>
                                            <div className="flex justify-between text-xs">
                                                <span className="text-slate-500">入力</span>
                                                <span className="text-slate-600">{u.prompt_tokens.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between text-xs">
                                                <span className="text-slate-500">出力</span>
                                                <span className="text-slate-600">{u.completion_tokens.toLocaleString()}</span>
                                            </div>
                                            <div className="flex justify-between text-xs pt-1 border-t border-slate-200">
                                                <span className="text-slate-500">概算</span>
                                                <span className={`font-bold ${api.textClass}`}>${cost.toFixed(4)}</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                        <div className="mt-3 pt-3 border-t border-slate-100 flex justify-between text-sm">
                            <span className="text-slate-500">総トークン</span>
                            <span className="font-bold text-slate-700">
                                {(usage.perplexity.prompt_tokens + usage.perplexity.completion_tokens + 
                                  usage.gemini.prompt_tokens + usage.gemini.completion_tokens + 
                                  usage.openai.prompt_tokens + usage.openai.completion_tokens).toLocaleString()}
                            </span>
                            <span className="text-slate-500 ml-4">概算コスト</span>
                            <span className="font-bold text-slate-500">${totalCost.toFixed(4)}</span>
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-6xl mx-auto p-6">
                    <header className="mb-6">
                        <h1 className="text-2xl font-bold text-slate-800">Agency Analyzer Pro</h1>
                        <p className="text-sm text-slate-500">タレント情報詳細調査ツール（データ取得日: {CURRENT_DATE}）</p>
                    </header>

                    {error && <div className="bg-slate-100 text-slate-600 p-4 rounded mb-4 border border-slate-300">{error}</div>}
                    
                    <UsagePanel />

                    {phase === 'input' && (
                        <div className="bg-white p-6 rounded-lg shadow-sm border">
                            {/* 接続テスト */}
                            <div className="mb-4 p-3 bg-slate-50 rounded border">
                                <div className="flex flex-wrap gap-2 mb-2">
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const res = await fetch(PROXY_URL, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ target: 'test' })
                                                });
                                                const text = await res.text();
                                                alert(`Status: ${res.status}\nResponse: ${text}`);
                                            } catch (e) {
                                                alert(`Error: ${e.message}\nURL: ${PROXY_URL}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-200 rounded text-sm hover:bg-slate-300"
                                    >
                                        🔧 接続
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const res = await fetch(PROXY_URL, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ target: 'check_keys' })
                                                });
                                                const data = await res.json();
                                                alert(`APIキー設定状況:\n\nGemini: ${data.gemini}\nPerplexity: ${data.perplexity}\nOpenAI: ${data.openai}\nYouTube: ${data.youtube}\nRapidAPI(Twitter): ${data.rapidapi}\nキャッシュ: ${data.cache || '不明'}`);
                                            } catch (e) {
                                                alert(`Error: ${e.message}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-100 rounded text-sm hover:bg-slate-200"
                                    >
                                        🔑 APIキー
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const testName = prompt('テスト検索するYouTuberやアーティスト名を入力:', 'HIKAKIN');
                                                if (!testName) return;
                                                const result = await searchYouTubeByName(testName);
                                                if (result) {
                                                    alert(`YouTube API テスト成功!\n\nチャンネル: ${result.title}\n登録者数: ${result.subscriberCountFormatted}\nURL: ${result.url}`);
                                                } else {
                                                    alert('YouTube API: チャンネルが見つかりませんでした');
                                                }
                                            } catch (e) {
                                                alert(`YouTube API Error: ${e.message}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-100 rounded text-sm hover:bg-slate-200"
                                    >
                                        📺 YouTube
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const testName = prompt('テスト検索するTwitterユーザー名または名前を入力:', 'hiaboron');
                                                if (!testName) return;
                                                // @付きまたはURLの場合はgetTwitterStats、それ以外はsearchTwitterByName
                                                let result;
                                                if (testName.startsWith('@') || testName.includes('twitter.com') || testName.includes('x.com')) {
                                                    const url = testName.startsWith('@') ? `https://x.com/${testName.slice(1)}` : testName;
                                                    result = await getTwitterStats(url);
                                                } else {
                                                    result = await searchTwitterByName(testName);
                                                }
                                                if (result) {
                                                    alert(`Twitter API テスト成功!\n\n名前: ${result.name}\nユーザー名: @${result.username}\nフォロワー数: ${result.followersCountFormatted}\n認証: ${result.verified ? '✓' : '-'}`);
                                                } else {
                                                    alert('Twitter API: ユーザーが見つかりませんでした');
                                                }
                                            } catch (e) {
                                                alert(`Twitter API Error: ${e.message}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-100 rounded text-sm hover:bg-slate-200"
                                    >
                                        🐦 Twitter
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const testName = prompt('CD検索するアーティスト名を入力:', 'YOASOBI');
                                                if (!testName) return;
                                                const result = await searchCDInfo(testName);
                                                if (result && result.items.length > 0) {
                                                    const latest = result.items[0];
                                                    alert(`CD API テスト成功!\n\nアーティスト: ${testName}\n件数: ${result.count}件\n\n【最新】\nタイトル: ${latest.title}\n発売日: ${latest.release_date}\n価格: ¥${latest.price}\n品番: ${latest.hinban}`);
                                                } else {
                                                    alert('CD API: データが見つかりませんでした');
                                                }
                                            } catch (e) {
                                                alert(`CD API Error: ${e.message}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-100 rounded text-sm hover:bg-slate-200"
                                    >
                                        CD検索
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const testName = prompt('Spotify検索するアーティスト名を入力:', 'YOASOBI');
                                                if (!testName) return;
                                                const result = await searchSpotify(testName);
                                                if (result) {
                                                    const topTrack = result.top_tracks?.[0];
                                                    alert(`Spotify API テスト成功!\n\nアーティスト: ${result.name}\nフォロワー: ${result.followersFormatted}\n人気度: ${result.popularity}/100\nジャンル: ${result.genres?.slice(0,3).join(', ') || '-'}\n\n【人気曲1位】\n${topTrack?.name || '-'}`);
                                                } else {
                                                    alert('Spotify API: アーティストが見つかりませんでした');
                                                }
                                            } catch (e) {
                                                alert(`Spotify API Error: ${e.message}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-100 rounded text-sm hover:bg-slate-200"
                                    >
                                        🎵 Spotify
                                    </button>
                                    <button 
                                        onClick={async () => {
                                            try {
                                                const res = await fetch(PROXY_URL, {
                                                    method: 'POST',
                                                    headers: { 'Content-Type': 'application/json' },
                                                    body: JSON.stringify({ target: 'cache_stats' })
                                                });
                                                const data = await res.json();
                                                const action = confirm(`キャッシュ統計:\n\nキャッシュ件数: ${data.count}件\nサイズ: ${data.totalSizeMB}MB\n\n「OK」でキャッシュをクリア\n「キャンセル」で閉じる`);
                                                if (action) {
                                                    const clearRes = await fetch(PROXY_URL, {
                                                        method: 'POST',
                                                        headers: { 'Content-Type': 'application/json' },
                                                        body: JSON.stringify({ target: 'cache_clear', payload: {} })
                                                    });
                                                    const clearData = await clearRes.json();
                                                    alert(`キャッシュをクリアしました: ${clearData.deleted}件削除`);
                                                }
                                            } catch (e) {
                                                alert(`Cache Error: ${e.message}`);
                                            }
                                        }}
                                        className="px-3 py-1.5 bg-slate-100 rounded text-sm hover:bg-slate-200"
                                    >
                                        キャッシュ
                                    </button>
                                </div>
                                <span className="text-xs text-slate-500">URL: {PROXY_URL}</span>
                            </div>
                            
                            <div className="flex gap-2 mb-4">
                                <button onClick={() => setMode('web')} className={`flex-1 py-3 rounded font-medium ${mode === 'web' ? 'bg-slate-800 text-white' : 'bg-slate-100'}`}>Web検索</button>
                                <button onClick={() => setMode('text')} className={`flex-1 py-3 rounded font-medium ${mode === 'text' ? 'bg-slate-800 text-white' : 'bg-slate-100'}`}>📝 テキスト</button>
                                <button onClick={() => setMode('history')} className={`flex-1 py-3 rounded font-medium ${mode === 'history' ? 'bg-slate-800 text-white' : 'bg-slate-100'}`}>履歴 ({historyList.length})</button>
                            </div>
                            
                            {mode === 'web' && (
                                <>
                                    <input value={agencyName} onChange={e => setAgencyName(e.target.value)} placeholder="事務所名" className="w-full p-4 border rounded mb-4" />
                                    <button onClick={handleExtract} disabled={!agencyName} className="w-full bg-slate-800 text-white py-4 rounded font-medium hover:bg-slate-700 disabled:opacity-50">
                                        タレントリスト取得
                                    </button>
                                </>
                            )}
                            
                            {mode === 'text' && (
                                <>
                                    <textarea value={rawText} onChange={e => setRawText(e.target.value)} placeholder="タレント一覧をペースト" className="w-full p-4 border rounded h-40 mb-4" />
                                    <button onClick={handleExtract} disabled={!rawText} className="w-full bg-slate-800 text-white py-4 rounded font-medium hover:bg-slate-700 disabled:opacity-50">
                                        タレントリスト取得
                                    </button>
                                </>
                            )}
                            
                            {mode === 'history' && (
                                <div className="space-y-4">
                                    {/* 検索・フィルター */}
                                    <div className="flex gap-2">
                                        <input 
                                            value={historySearch} 
                                            onChange={e => setHistorySearch(e.target.value)} 
                                            placeholder="タレント名で検索..." 
                                            className="flex-1 p-3 border rounded"
                                        />
                                        <select 
                                            value={historyAgency} 
                                            onChange={e => setHistoryAgency(e.target.value)}
                                            className="p-3 border rounded min-w-[150px]"
                                        >
                                            <option value="">全事務所</option>
                                            {historyAgencies.map(a => (
                                                <option key={a} value={a}>{a}</option>
                                            ))}
                                        </select>
                                        <button 
                                            onClick={loadHistory} 
                                            className="px-4 py-2 bg-slate-200 rounded hover:bg-slate-300"
                                            disabled={historyLoading}
                                        >
                                            {historyLoading ? '↻' : '更新'}
                                        </button>
                                    </div>
                                    
                                    {/* 一括操作 */}
                                    <div className="flex gap-2 items-center">
                                        <button 
                                            onClick={() => setHistorySelected(new Set(historyList.map(h => h.talentName + '|' + h.agencyName)))}
                                            className="px-3 py-1 text-sm bg-slate-200 rounded"
                                        >
                                            全選択
                                        </button>
                                        <button 
                                            onClick={() => setHistorySelected(new Set())}
                                            className="px-3 py-1 text-sm bg-slate-100 rounded"
                                        >
                                            解除
                                        </button>
                                        <span className="text-sm text-slate-500">{historySelected.size}件選択中</span>
                                    </div>
                                    
                                    {/* 履歴一覧 */}
                                    <div className="max-h-[50vh] overflow-y-auto border rounded">
                                        {historyList.length === 0 ? (
                                            <div className="p-8 text-center text-slate-400">
                                                {historyLoading ? '読み込み中...' : 'キャッシュデータがありません'}
                                            </div>
                                        ) : (
                                            <table className="w-full text-sm">
                                                <thead className="bg-slate-50 sticky top-0">
                                                    <tr>
                                                        <th className="p-2 text-left w-8">
                                                            <input 
                                                                type="checkbox" 
                                                                checked={historySelected.size === historyList.length && historyList.length > 0}
                                                                onChange={(e) => {
                                                                    if (e.target.checked) {
                                                                        setHistorySelected(new Set(historyList.map(h => h.talentName + '|' + h.agencyName)));
                                                                    } else {
                                                                        setHistorySelected(new Set());
                                                                    }
                                                                }}
                                                            />
                                                        </th>
                                                        <th className="p-2 text-left">タレント名</th>
                                                        <th className="p-2 text-left">事務所</th>
                                                        <th className="p-2 text-left">Twitter</th>
                                                        <th className="p-2 text-left">YouTube</th>
                                                        <th className="p-2 text-left">更新日</th>
                                                        <th className="p-2 text-left">経過</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    {historyList.map((h, i) => {
                                                        const key = h.talentName + '|' + h.agencyName;
                                                        return (
                                                            <tr 
                                                                key={i} 
                                                                className={`border-t hover:bg-slate-50 cursor-pointer ${historySelected.has(key) ? 'bg-slate-50' : ''}`}
                                                                onClick={() => {
                                                                    const s = new Set(historySelected);
                                                                    s.has(key) ? s.delete(key) : s.add(key);
                                                                    setHistorySelected(s);
                                                                }}
                                                            >
                                                                <td className="p-2">
                                                                    <input 
                                                                        type="checkbox" 
                                                                        checked={historySelected.has(key)}
                                                                        onChange={() => {}}
                                                                    />
                                                                </td>
                                                                <td className="p-2 font-medium">{h.summary?.name || h.talentName}</td>
                                                                <td className="p-2 text-slate-500">{h.agencyName}</td>
                                                                <td className="p-2 text-slate-500">{h.summary?.twitter || '-'}</td>
                                                                <td className="p-2 text-slate-500">{h.summary?.youtube || '-'}</td>
                                                                <td className="p-2 text-slate-400">{h.updatedAtFormatted}</td>
                                                                <td className="p-2">
                                                                    <span className={`text-xs px-2 py-0.5 rounded ${h.age < 7 ? 'bg-slate-100 text-slate-600' : h.age < 30 ? 'bg-slate-100 text-slate-600' : 'bg-slate-100 text-slate-500'}`}>
                                                                        {h.age < 1 ? '今日' : `${Math.floor(h.age)}日前`}
                                                                    </span>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        )}
                                    </div>
                                    
                                    {/* アクションボタン */}
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={loadFromHistory} 
                                            disabled={historySelected.size === 0}
                                            className="flex-1 bg-slate-800 text-white py-4 rounded font-medium hover:bg-slate-700 disabled:opacity-50"
                                        >
                                            履歴から表示 ({historySelected.size}件)
                                        </button>
                                        <button 
                                            onClick={deleteHistory} 
                                            disabled={historySelected.size === 0 || historyDeleting}
                                            className="px-6 py-4 bg-slate-100 text-slate-600 rounded font-medium hover:bg-slate-200 disabled:opacity-50"
                                        >
                                            {historyDeleting ? '削除中...' : `削除 (${historySelected.size}件)`}
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    )}

                    {phase === 'extracting' && (
                        <div className="text-center p-16 bg-white rounded border">
                            <span className="spinner text-3xl">↻</span>
                            <p className="mt-4">{loading}</p>
                            <button 
                                onClick={() => { setPhase('input'); setLoading(''); }} 
                                className="mt-6 px-4 py-2 text-sm bg-slate-200 hover:bg-slate-300 rounded"
                            >
                                ← キャンセル
                            </button>
                        </div>
                    )}

                    {phase === 'review' && roster && (
                        <div className="bg-white rounded shadow-sm border">
                            <div className="p-4 border-b flex justify-between items-center bg-slate-50">
                                <div className="flex items-center gap-4">
                                    <button 
                                        onClick={() => { setPhase('input'); setRoster(null); setSelected(new Set()); }} 
                                        className="px-3 py-2 text-sm bg-slate-200 hover:bg-slate-300 rounded flex items-center gap-1"
                                    >
                                        ← 戻る
                                    </button>
                                    <div>
                                        <h2 className="font-bold text-lg">{roster.agency_name}</h2>
                                        <p className="text-sm text-slate-500">{roster.talents.length}名 / {selected.size}名選択</p>
                                    </div>
                                </div>
                                <div className="flex items-center gap-3">
                                    {/* 検索モード選択 */}
                                    <div className="flex rounded-lg border border-slate-300 overflow-hidden">
                                        <button 
                                            onClick={() => setSearchMode('quick')} 
                                            className={`px-4 py-2 text-sm font-medium ${searchMode === 'quick' ? 'bg-slate-700 text-white' : 'bg-white text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            クイック
                                        </button>
                                        <button 
                                            onClick={() => setSearchMode('full')} 
                                            className={`px-4 py-2 text-sm font-medium ${searchMode === 'full' ? 'bg-slate-700 text-white' : 'bg-white text-slate-600 hover:bg-slate-50'}`}
                                        >
                                            詳細
                                        </button>
                                    </div>
                                    <button onClick={() => handleAnalyze(searchMode)} disabled={selected.size === 0} className="bg-slate-800 text-white px-6 py-3 rounded font-medium disabled:opacity-50">
                                        {searchMode === 'quick' ? `クイック (${selected.size}名)` : `詳細 (${selected.size}名)`} →
                                    </button>
                                </div>
                            </div>
                            <div className="p-3 border-b bg-slate-50/50 flex gap-2 items-center flex-wrap">
                                <button onClick={() => setSelected(new Set(roster.talents.map(t => t.id)))} className="px-3 py-1 text-sm bg-slate-200 rounded">全選択</button>
                                <button onClick={() => setSelected(new Set())} className="px-3 py-1 text-sm bg-slate-100 rounded">解除</button>
                                <span className="text-xs text-slate-400 ml-2">
                                    {searchMode === 'quick' ? 'クイック: 2検索/名' : '詳細: 8検索/名'}
                                </span>
                            </div>
                            <div className="p-4 grid grid-cols-2 md:grid-cols-4 gap-2 max-h-[60vh] overflow-y-auto">
                                {roster.talents.map(t => (
                                    <label key={t.id} className="flex items-center gap-2 p-3 border rounded cursor-pointer hover:bg-slate-50">
                                        <input type="checkbox" checked={selected.has(t.id)} onChange={() => {
                                            const s = new Set(selected);
                                            s.has(t.id) ? s.delete(t.id) : s.add(t.id);
                                            setSelected(s);
                                        }} />
                                        <span className="truncate">{t.name}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                    )}

                    {(phase === 'analyzing' || phase === 'done') && (
                        <div>
                            <div className="bg-white p-4 rounded border mb-4 flex items-center gap-4 sticky top-2 z-10">
                                {phase === 'analyzing' && !paused && <span className="spinner">↻</span>}
                                <div className="flex-grow">
                                    <span className="font-bold">{phase === 'analyzing' ? `調査中 ${progress.c}/${progress.t}` : `完了 ${Object.keys(results).length}件`}</span>
                                    {progress.s && <p className="text-xs text-slate-500">{progress.s}</p>}
                                    {phase === 'analyzing' && <div className="w-full bg-slate-200 rounded-full h-1.5 mt-2"><div className="bg-slate-600 h-1.5 rounded-full" style={{ width: `${(progress.c / progress.t) * 100}%` }}></div></div>}
                                </div>
                                <div className="flex gap-2">
                                    {phase === 'analyzing' && (
                                        <>
                                            <button onClick={() => { setPhase('review'); setResults({}); abortRef.current = true; }} className="px-3 py-2 rounded text-sm bg-slate-200 hover:bg-slate-300">← 戻る</button>
                                            <button onClick={toggle} className={`px-3 py-2 rounded text-sm ${paused ? 'bg-slate-700 text-white' : 'bg-slate-300 hover:bg-slate-400'}`}>{paused ? '▶ 再開' : '⏸ 一時停止'}</button>
                                            <button onClick={abort} className="px-3 py-2 rounded text-sm bg-slate-500 text-white hover:bg-slate-600">⏹ 中断</button>
                                        </>
                                    )}
                                    {phase === 'done' && (
                                        <>
                                            <button onClick={() => { setPhase('review'); setResults({}); }} className="px-4 py-2 rounded text-sm bg-slate-200 hover:bg-slate-300">← タレント選択に戻る</button>
                                            {/* クイック後の詳細ボタン */}
                                            {Object.values(results).some(r => !r._detailSearched && !r.error) && (
                                                <button 
                                                    onClick={() => {
                                                        const ids = Object.entries(results)
                                                            .filter(([_, r]) => !r._detailSearched && !r.error)
                                                            .map(([id]) => id);
                                                        handleDetailSearch(ids);
                                                    }} 
                                                    className="px-4 py-2 rounded text-sm bg-slate-500 text-white hover:bg-slate-800"
                                                >
                                                    全員を詳細調査 ({Object.values(results).filter(r => !r._detailSearched && !r.error).length}名)
                                                </button>
                                            )}
                                            <button onClick={() => { setPhase('input'); setRoster(null); setResults({}); setSelected(new Set()); }} className="px-4 py-2 rounded text-sm bg-slate-700 text-white hover:bg-slate-800">新規検索</button>
                                            <button onClick={downloadCSV} className="px-4 py-2 rounded text-sm bg-slate-600 text-white hover:bg-slate-700">CSV</button>
                                        </>
                                    )}
                                </div>
                            </div>
                            
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                {Array.from(selected).map(id => {
                                    const t = roster.talents.find(x => x.id === id);
                                    const r = results[id];
                                    if (!r) return <div key={id} className="bg-slate-100 rounded h-64 flex items-center justify-center"><span className="text-slate-400">{t?.name} 調査中...</span></div>;
                                    if (r.error) return <div key={id} className="bg-slate-100 rounded p-4 border border-slate-300"><div className="font-bold text-slate-600">{r.name}</div><div className="text-xs text-slate-500">{r.message}</div></div>;
                                    return <TalentCard key={id} data={t} result={r} onDetailSearch={(tid) => handleDetailSearch([tid])} />;
                                })}
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
